---
title: "Value of pregnancy complications in risk prediction modelling for CVD"
output: 
  html_notebook: 
    toc: yes
    toc_depth: 4
    number_sections: yes
---



```{r}
rm(list=ls())

```



## Objectives of the document

The objectives of this document are;

__1.__ Externally validate QRISK3 using CPRD Gold dataset in women with a history of pregnancy (aged 25 and above as QRISK3 was developed for those aged 25 to 84 years)
__2.__ Use the QRISK®-3 model coefficients in (i) above as a single predictor and add additional candidate predictors to develop and internally validate an updated risk prediction model (Model 1).
__3.__ Develop and internally validate a risk prediction model using all predictors, i.e., QRISK®-3 predictors plus additional candidate predictors (Model 2), allowing for variable selection via the LASSO.
__4.__ Compare predictive performance measures (calibration and discrimination) of QRISK®-3, Model 1 and Model 2, using internal validation techniques.


## Objective 1: QRISK3 external validation

### Set up - load packages and import data
 
```{r}
library(tidyverse)

library(riskRegression)
library(plyr)
#library(tidysurv)
library(data.table)
library(stringr)
library(parallel)
library(tableone)
library(muhaz)
library(survival)
library(Hmisc)
library(MASS)
library(mfp)
library(reshape2)
library(flexsurv)
library(devtools)
library(prodlim)
library(rms)
library(rstpm2)
library(survcomp)
library(glmnet)
library(caret)
library(sjPlot)
library(knitr)
library(webshot)
library(pROC)
library(rmda)
library(pseudo)
library(lava)
library(pec)


# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("survcomp")

#library(survcomp)

options(show.signif.stars = FALSE)  # display statistical intelligence
palette("Okabe-Ito")  # color-blind friendly  (needs R 4.0)

```



### Importing data

```{r}
validation_data1 = readRDS("/rds/projects/g/gokhalkm-optimal/DataForSteven/2024 data cleaning for QRISK3/ValidationData020624 Final.rds")

validation_data1 = data.frame(validation_data1)


# validation_data1 = readRDS("/rds/projects/g/gokhalkm-optimal/DataForSteven/2024 data cleaning for QRISK3/validation_data15to49_120224_140424.rds")
# validation_data1 = data.frame(validation_data1)
# 
# 
# x = readRDS("/rds/projects/g/gokhalkm-optimal/DataForSteven/2024 data cleaning for QRISK3/ValidationData020624 Final.rds")
# x = data.frame(x)
# 
# x = x %>% dplyr::select(PRACTICE_PATIENT_ID,stillbirth,b_atypicalantipsy, b_corticosteroids,b_treatedhyp)
# 
# validation_data1 = validation_data1 %>% dplyr::select(-b_atypicalantipsy, -b_corticosteroids,-b_treatedhyp)
# 
# validation_data1 = left_join(validation_data1,x,by=c("PRACTICE_PATIENT_ID"))
# 

```



```{r}

validation_data1 = validation_data1 %>% dplyr::select(PRACTICE_PATIENT_ID, INDEX_DATE, time, status, age, 
bmi, bmi_inc, rati, chol_ratio_inc, sbp, sbp_inc, 
sbps5, sbp_sd_inc, sbp_sd1, town, White, Indian, 
Pakistani, Banglandeshi, Other_asian, Black_caribbean, 
Black_african, Chinese, Other_ethnicity, cprd_ethnicity3_inc, 
Non_smoker, Ex_smoker, Light_smoker, smoking_status_combined0, 
smoking_status_combined, smoking_status_combined1_inc, non_smoker1, 
ex_smoker1, light_smoker1, moderate_smoker1, heavy_smoker1, 
smoking_status_combined1, non_smoker2, ex_smoker2, light_smoker2, 
moderate_smoker2, heavy_smoker2, smoking_inc, smoking_inc2, 
b_AF, b_atypicalantipsy, b_corticosteroids, b_migraine, 
b_ra, CkdB, b_renal, b_semi, SmirrB_new1, b_sle, 
b_treatedhyp, b_type1, b_type2, fh_cvd, pregnancies, 
preeclampsia, small_for_gest, postnatal_dep, gdm, gest_hyp, 
miscarriage, preterm_birth, Placental_abruption, endometriosis, 
IrregularMenses_B, irregular_menses, pcos, town_inc, 
preg_cats, ethnicity, gen_ethnicity, cprd_ethnicity2, 
cprd_ethnicity3, cprd_white, cprd_black, cprd_mixed, 
cprd_asian, cprd_other, hes_apc_e, Moderate_smoker, Heavy_smoker, 
age_cat, age0,stillbirth)


```


```{r}
continuous_vars = validation_data1 %>% dplyr::select(bmi_inc,chol_ratio_inc,sbp_inc,sbp_sd_inc)

saveRDS(continuous_vars,"continuous_vars.rds")

```


Censoring of events and follow-up to 10 years

```{r}

validation_data1$time1 = validation_data1$time
validation_data1$status1 = validation_data1$status

validation_data1$status[validation_data1$time>10] <-0# censor events after 10 years
validation_data1$time[validation_data1$time>10] <- 10 # truncate survival time at 10 years

```


```{r}
summary(validation_data1$age)
```



```{r}

#validation_data1$age = validation_data1$age0

summary(validation_data1$age)
```



```{r}

#validation_data1$age = validation_data1$age0

summary(validation_data1$age0)
```



```{r}
options(bitmapType='cairo')
```



```{r}


# Development set
sfit_rott <- survfit(Surv(time1, status1 == 1) ~ 1, 
                     data = validation_data1) # survival
sfit_rott_c <- survfit(Surv(time1, status1 == 0) ~ 1, 
                       data = validation_data1) # censoring

# Plots development data
dev_plots <- list()

library(survminer)
# KM plot - development data
dev_plots[[1]] <- survminer::ggsurvplot(sfit_rott, data = validation_data1,
                                        risk.table = TRUE,
                                        risk.table.fontsize = 1.5,
                                        palette = 3,
                                        size = 1.5,
                                        censor = FALSE,
                                        legend = "none",
                                        title = "Failure-free survival",
                                        xlab = "Years",
                                        ylab = "Probability",
                                        tables.theme = theme_cleantable(),
                                        xlim=c(0,15))

dev_plots[[1]]$table <- dev_plots[[1]]$table + 
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


# Censoring plot - development data
dev_plots[[2]] <- survminer::ggsurvplot(sfit_rott_c, data = validation_data1,
                                        risk.table = TRUE,
                                        risk.table.fontsize = 1.5,
                                        palette = 2,
                                        size = 1.5,
                                        censor = FALSE,
                                        legend = "none",
                                        title = "Censoring",
                                        xlab = "Years",
                                        ylab = "Probability",
                                        # risk.table.title = "Number at risk",
                                        # risk.table.y.text.col =  TRUE,
                                        tables.theme = theme_cleantable(),
                                        xlim=c(0,15))

dev_plots[[2]]$table <- dev_plots[[2]]$table + 
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# Join together 
p1=survminer::arrange_ggsurvplots(dev_plots, print = TRUE,
                               ncol = 2, nrow = 1, risk.table.height = 0.15,
                               title = "")

ggsave(p1,filename = "CVD Survival function.jpeg")

```



### Reverse the outcome indicator

```{r}

x = validation_data1

x$status2 = ifelse(x$status1==1,0,1)

# Development set
sfit_rott <- survfit(Surv(time1, status2 == 1) ~ 1, 
                     data = x) # survival
sfit_rott_c <- survfit(Surv(time1, status2 == 0) ~ 1, 
                       data = x) # censoring

# Plots development data
dev_plots <- list()

library(survminer)
# KM plot - development data
dev_plots[[1]] <- survminer::ggsurvplot(sfit_rott, data = x,
                                        risk.table = TRUE,
                                        risk.table.fontsize = 1.5,
                                        palette = 3,
                                        size = 1.5,
                                        censor = FALSE,
                                        legend = "none",
                                        title = "Reversed outcome",
                                        xlab = "Years",
                                        ylab = "Probability",
                                        tables.theme = theme_cleantable(),
                                        xlim=c(0,15))

dev_plots[[1]]$table <- dev_plots[[1]]$table + 
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )


# Censoring plot - development data
dev_plots[[2]] <- survminer::ggsurvplot(sfit_rott_c, data = x,
                                        risk.table = TRUE,
                                        risk.table.fontsize = 1.5,
                                        palette = 2,
                                        size = 1.5,
                                        censor = FALSE,
                                        legend = "none",
                                        title = "Censoring",
                                        xlab = "Years",
                                        ylab = "Probability",
                                        # risk.table.title = "Number at risk",
                                        # risk.table.y.text.col =  TRUE,
                                        tables.theme = theme_cleantable(),
                                        xlim=c(0,15))

dev_plots[[2]]$table <- dev_plots[[2]]$table + 
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

# Join together 
p1=survminer::arrange_ggsurvplots(dev_plots, print = TRUE,
                               ncol = 2, nrow = 1, risk.table.height = 0.1,
                               title = "")

ggsave(p1,filename = "CVD Survival function V2.jpeg")

#ggsave(dev_plots[[1]],filename = "CVD Survival function V3.jpeg")


```





```{r}
# Reverse Kaplan-Meier: Treat censoring times as "events" and event times as "censoring"
reverse_km_fit <- survfit(Surv(time1, 1 - status1) ~ 1, data = validation_data1)

# Summary of the reverse Kaplan-Meier fit
reverse_km_summary <- summary(reverse_km_fit)

# Extract the median and 95% confidence intervals for the follow-up
median_follow_up <- reverse_km_summary$table["median"]
conf_int_lower <- reverse_km_summary$table["0.95LCL"]
conf_int_upper <- reverse_km_summary$table["0.95UCL"]

# Print the results
print(paste("Median follow-up time:", median_follow_up))
print(paste("95% CI for follow-up time: [", conf_int_lower, ", ", conf_int_upper, "]", sep = ""))


```



```{r}

# Plot the reverse Kaplan-Meier curve
plot(reverse_km_fit, xlab = "Time", ylab = "Follow-up Probability",
     main = "Reverse Kaplan-Meier Estimate of Follow-up Distribution")

```


```{r}

# Extract survival probabilities and time points
surv_prob <- reverse_km_fit$surv
time_points <- reverse_km_fit$time

# Function to find the quantile
find_quantile <- function(prob, surv_prob, time_points) {
  idx <- which.min(abs(surv_prob - prob))
  return(time_points[idx])
}

# Calculate the 25th percentile, median, and 75th percentile
quantiles <- sapply(c(0.75, 0.5, 0.25), find_quantile, surv_prob = surv_prob, time_points = time_points)

# Plot the reverse Kaplan-Meier curve
plot(reverse_km_fit, xlab = "Time", ylab = "Follow-up Probability",
     main = "Reverse Kaplan-Meier Estimate of Follow-up Distribution", conf.int = TRUE)

# Add vertical lines for the quantiles
abline(v = quantiles, col = c("blue", "red", "green"), lty = 2)

# Add labels for the quantiles
text(x = quantiles, y = 0.5, labels = c("75th Percentile", "Median", "25th Percentile"), col = c("blue", "red", "green"), pos = 4)

# Print the quantiles
print(paste("25th Percentile follow-up time:", quantiles[3]))
print(paste("Median follow-up time:", quantiles[2]))
print(paste("75th Percentile follow-up time:", quantiles[1]))




```


```{r}

```




### Calculating QRISK3 score - Original model

```{r}
#Applying the fractional polynomial transforms  for continuous variables
attach(validation_data1)

age_1 = (age/10)^-2
age_2 = age/10
bmi_1 = (bmi/10)^-2
bmi_2 = ((bmi/10)^-2)*log(bmi/10)

#Centering the continuous variables
age_1 = age_1-0.053274843841791
age_2 = age_2-4.332503318786621
bmi_1 = bmi_1-0.154946178197861
bmi_2 = bmi_2-0.144462317228317
rati = rati-3.476326465606690
sbp = sbp-123.130012512207030
sbps5 = sbps5-9.002537727355957
town = town-0.392308831214905

#Baseline hazard
S10 = 0.988876402378082

#Linear predictor
LP = (
  
  #continuous variables
  age_1*-8.1388109247726188000000000) +
     (age_2*0.7973337668969909800000000)+
      (bmi_1*0.2923609227546005200000000)+
      (bmi_2* -4.1513300213837665000000000)+
      (rati*0.1533803582080255400000000)+
      (sbp*0.0131314884071034240000000)+
      (sbps5*0.0078894541014586095000000)+
       (town*0.0772237905885901080000000)+

  #Ethnicity
(White*0)+
(Indian*0.2804031433299542500000000)+
(Pakistani*0.5629899414207539800000000)+
(Banglandeshi*0.2959000085111651600000000)+
(Other_asian*0.0727853798779825450000000)+
(Black_caribbean* -0.1707213550885731700000000)+
(Black_african* -0.3937104331487497100000000)+
(Chinese* -0.3263249528353027200000000)+
(Other_ethnicity* -0.1712705688324178400000000)+

  #Smoking
 (non_smoker2*0)+
 (ex_smoker2*0.1338683378654626200000000)+
 (light_smoker2*0.5620085801243853700000000)+
 (moderate_smoker2*0.6674959337750254700000000)+
 (heavy_smoker2*0.8494817764483084700000000)+
  
  #Health conditions and medications
(b_AF*1.5923354969269663000000000)+
(b_atypicalantipsy*0.25237642070115557000000000)+
(b_corticosteroids*0.5952072530460185100000000)+
(b_migraine*0.3012672608703450000000000)+
(b_ra*0.2136480343518194200000000)+
(b_renal*0.6519456949384583300000000)+
(b_semi*0.1255530805882017800000000)+
(b_sle*0.7588093865426769300000000)+
(b_treatedhyp*0.5093159368342300400000000)+
(b_type1*1.7267977510537347000000000)+
(b_type2*1.0688773244615468000000000)+
(fh_cvd*0.4544531902089621300000000)+

#Interaction terms
  (age_1*(Ex_smoker)* -4.7057161785851891000000000)+
	(age_1*(Light_smoker)* -2.74303834035733370000000000)+
	(age_1*(Moderate_smoker)* -0.8660808882939218200000000)+
	(age_1*(Heavy_smoker)*0.9024156236971064800000000)+
	(age_1*b_AF* 19.9380348895465610000000000)+
	(age_1*b_corticosteroids* -0.9840804523593628100000000)+
	(age_1*b_migraine*1.7634979587872999000000000)+
	(age_1*b_renal* -3.5874047731694114000000000)+
	(age_1*b_sle*19.6903037386382920000000000)+
	(age_1*b_treatedhyp*11.8728097339218120000000000)+
	(age_1*b_type1* -1.2444332714320747000000000)+
	(age_1*b_type2*6.8652342000009599000000000)+
	(age_1*bmi_1*23.8026234121417420000000000)+
	(age_1*bmi_2* -71.1849476920870070000000000)+
	(age_1*fh_cvd*0.9946780794043512700000000)+
	(age_1*sbp*0.0341318423386154850000000)+
	(age_1*town* -1.0301180802035639000000000)+
	(age_2*(Ex_smoker)* -0.0755892446431930260000000)+
	(age_2*(Light_smoker)* -0.11951192874867074000000000)+
	(age_2*(Moderate_smoker)* -0.1036630639757192300000000)+
	(age_2*(Heavy_smoker)* -0.1399185359171838900000000)+
	(age_2*b_AF* -0.0761826510111625050000000)+
	(age_2*b_corticosteroids* -0.1200536494674247200000000)+
	(age_2*b_migraine* -0.0655869178986998590000000)+
	(age_2*b_renal* -0.2268887308644250700000000)+
	(age_2*b_sle*0.0773479496790162730000000)+
	(age_2*b_treatedhyp*0.0009685782358817443600000)+
	(age_2*b_type1* -0.2872406462448894900000000)+
	(age_2*b_type2* -0.0971122525906954890000000)+
	(age_2*bmi_1*0.5236995893366442900000000)+
	(age_2*bmi_2*0.0457441901223237590000000)+
	(age_2*fh_cvd* -0.0768850516984230380000000)+
	(age_2*sbp* -0.0015082501423272358000000)+
	(age_2*town* -0.0315934146749623290000000)

validation_data1$LP = LP  #linear predictor

validation_data1$score = (1-(S10^exp(validation_data1$LP))) #QRISK3 score (can be converted to a percentage by multiplying by 100)
detach(validation_data1)


s10_qrisk3 = S10

```



```{r}

h = validation_data1 %>% dplyr::select(age,White,Indian,Pakistani,Banglandeshi,Other_asian,Black_caribbean,Black_african,Chinese,Other_ethnicity,town,Non_smoker,Ex_smoker,Light_smoker,Moderate_smoker,Heavy_smoker, b_type1,b_type2, fh_cvd,  b_renal,  b_AF, b_treatedhyp, b_migraine, b_ra,b_sle,b_semi,b_atypicalantipsy,b_corticosteroids,rati, sbp, sbps5,bmi,score,LP
                                       
                                       
                                       ) %>% 
  dplyr::mutate(age_1 = (age/10)^-2,
age_2 = age/10,
bmi_1 = (bmi/10)^-2,
bmi_2 = ((bmi/10)^-2)*log(bmi/10),

#Centering the continuous variables
age_1C = age_1-0.053274843841791,
age_2C = age_2-4.332503318786621,
bmi_1C = bmi_1-0.154946178197861,
bmi_2C = bmi_2-0.144462317228317,
ratiC = rati-3.476326465606690,
sbpC = sbp-123.130012512207030,
sbps5C = sbps5-9.002537727355957,
townC = town-0.392308831214905)

h$score = round(h$score,4)

```


```{r}
df = subset(validation_data1,validation_data1$age<=30)
df$age_cat1 = ifelse(df$age<25,"below 25","age 25 to 30")

table(df$age_cat1)

```


QRISK3 score calculated (can be converted to a percentage by multiplying by 100)

###  Performance measures

```{r}

# Calibration slope
model0 <- coxph(Surv(validation_data1$time,validation_data1$status)~validation_data1$LP,method="breslow")

model0$coef


Uno_C = concordance(Surv(time,status) ~ LP, 
                           validation_data1, 
                           reverse = TRUE,
                           timewt = "n/G2")

Uno_TD <-
  timeROC::timeROC(
    T = validation_data1$time,
    delta = validation_data1$status,
    marker = validation_data1$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)




##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_overall <- data.frame(
  Model=c("QRISK3"),
  Mean=c(mean(validation_data1$LP)),
  sd=c(sd(validation_data1$LP)),
  minimum=c(min(validation_data1$LP)),
  maximum=c(max(validation_data1$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]

  TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(validation_data1$LP,surv.time=validation_data1$time,surv.event=validation_data1$status)$coef),
  D_se=c(D.index(validation_data1$LP,surv.time=validation_data1$time,surv.event=validation_data1$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

metrics_overall
```


### Performance measures by subgroups

#### Ethnicity

##### 1. White

```{r}

#White
white_ethnicity = subset(validation_data1,validation_data1$cprd_white==1)


model0 <- coxph(Surv(white_ethnicity$time,white_ethnicity$status)~white_ethnicity$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           white_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = white_ethnicity$time,
    delta = white_ethnicity$status,
    marker = white_ethnicity$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1


###---------Time dependent AUC using riskregression package--------------

vdata <- white_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_white <- data.frame(
  Model=c("QRISK3, White"),
  Mean=c(mean(white_ethnicity$LP)),
  sd=c(sd(white_ethnicity$LP)),
  minimum=c(min(white_ethnicity$LP)),
  maximum=c(max(white_ethnicity$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(white_ethnicity$LP,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$coef),
  D_se=c(D.index(white_ethnicity$LP,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 2. Black

```{r}

black_ethnicity = subset(validation_data1,validation_data1$cprd_black==1)


model0 <- coxph(Surv(black_ethnicity$time,black_ethnicity$status)~black_ethnicity$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           black_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = black_ethnicity$time,
    delta = black_ethnicity$status,
    marker = black_ethnicity$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- black_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_black <- data.frame(
  Model=c("QRISK3, Black"),
  Mean=c(mean(black_ethnicity$LP)),
  sd=c(sd(black_ethnicity$LP)),
  minimum=c(min(black_ethnicity$LP)),
  maximum=c(max(black_ethnicity$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(black_ethnicity$LP,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$coef),
  D_se=c(D.index(black_ethnicity$LP,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 3. Mixed

```{r}

#Mixed
mixed_ethnicity = subset(validation_data1,validation_data1$cprd_mixed==1)



model0 <- coxph(Surv(mixed_ethnicity$time,mixed_ethnicity$status)~mixed_ethnicity$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           mixed_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = mixed_ethnicity$time,
    delta = mixed_ethnicity$status,
    marker = mixed_ethnicity$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- mixed_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_mixed <- data.frame(
  Model=c("QRISK3, Mixed"),
  Mean=c(mean(mixed_ethnicity$LP)),
  sd=c(sd(mixed_ethnicity$LP)),
  minimum=c(min(mixed_ethnicity$LP)),
  maximum=c(max(mixed_ethnicity$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(mixed_ethnicity$LP,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$coef),
  D_se=c(D.index(mixed_ethnicity$LP,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 4. Asian

```{r}

#asian
asian_ethnicity = subset(validation_data1,validation_data1$cprd_asian==1)


model0 <- coxph(Surv(asian_ethnicity$time,asian_ethnicity$status)~asian_ethnicity$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           asian_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = asian_ethnicity$time,
    delta = asian_ethnicity$status,
    marker = asian_ethnicity$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- asian_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_asian <- data.frame(
  Model=c("QRISK3, Asian"),
  Mean=c(mean(asian_ethnicity$LP)),
  sd=c(sd(asian_ethnicity$LP)),
  minimum=c(min(asian_ethnicity$LP)),
  maximum=c(max(asian_ethnicity$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(asian_ethnicity$LP,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$coef),
  D_se=c(D.index(asian_ethnicity$LP,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 5. Other

```{r}

#other
other_ethnicity = subset(validation_data1,validation_data1$cprd_other==1)


model0 <- coxph(Surv(other_ethnicity$time,other_ethnicity$status)~other_ethnicity$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           other_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = other_ethnicity$time,
    delta = other_ethnicity$status,
    marker = other_ethnicity$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- other_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_other <- data.frame(
  Model=c("QRISK3, Other"),
  Mean=c(mean(other_ethnicity$LP)),
  sd=c(sd(other_ethnicity$LP)),
  minimum=c(min(other_ethnicity$LP)),
  maximum=c(max(other_ethnicity$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(other_ethnicity$LP,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$coef),
  D_se=c(D.index(other_ethnicity$LP,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


#### Age

##### 1. <25

```{r}
ageless25 = subset(validation_data1,validation_data1$age_cat=="<25")
#
model0 <- coxph(Surv(ageless25$time,ageless25$status)~ageless25$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           ageless25, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = ageless25$time,
    delta = ageless25$status,
    marker = ageless25$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- ageless25 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_ageless25 <- data.frame(
  Model=c("QRISK3, < 25"),
  Mean=c(mean(ageless25$LP)),
  sd=c(sd(ageless25$LP)),
  minimum=c(min(ageless25$LP)),
  maximum=c(max(ageless25$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(ageless25$LP,surv.time=ageless25$time,surv.event=ageless25$status)$coef),
  D_se=c(D.index(ageless25$LP,surv.time=ageless25$time,surv.event=ageless25$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))



```


##### 2. 25-34

```{r}
age25to34 = subset(validation_data1,validation_data1$age_cat=="25-34")

model0 <- coxph(Surv(age25to34$time,age25to34$status)~age25to34$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           age25to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age25to34$time,
    delta = age25to34$status,
    marker = age25to34$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


###---------Time dependent AUC using riskregression package--------------

vdata <- age25to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_age25to34 <- data.frame(
  Model=c("QRISK3, 25-34"),
  Mean=c(mean(age25to34$LP)),
  sd=c(sd(age25to34$LP)),
  minimum=c(min(age25to34$LP)),
  maximum=c(max(age25to34$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age25to34$LP,surv.time=age25to34$time,surv.event=age25to34$status)$coef),
  D_se=c(D.index(age25to34$LP,surv.time=age25to34$time,surv.event=age25to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 3. 35-49

```{r}

age35to49 = subset(validation_data1,validation_data1$age_cat=="35-49")


model0 <- coxph(Surv(age35to49$time,age35to49$status)~age35to49$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           age35to49, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age35to49$time,
    delta = age35to49$status,
    marker = age35to49$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05



###---------Time dependent AUC using riskregression package--------------

vdata <- age35to49 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_age35to49 <- data.frame(
  Model=c("QRISK3, 35-49"),
  Mean=c(mean(age35to49$LP)),
  sd=c(sd(age35to49$LP)),
  minimum=c(min(age35to49$LP)),
  maximum=c(max(age35to49$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age35to49$LP,surv.time=age35to49$time,surv.event=age35to49$status)$coef),
  D_se=c(D.index(age35to49$LP,surv.time=age35to49$time,surv.event=age35to49$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```



##### 4. <25-34

```{r}

age15to34 = filter(validation_data1,age_cat %in% c("<25","25-34"))


model0 <- coxph(Surv(age15to34$time,age15to34$status)~age15to34$LP,method="breslow")

Uno_C = concordance(Surv(time,status) ~ LP, 
                           age15to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age15to34$time,
    delta = age15to34$status,
    marker = age15to34$LP,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05



###---------Time dependent AUC using riskregression package--------------

vdata <- age15to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model0_age15to34 <- data.frame(
  Model=c("QRISK3, 15-34"),
  Mean=c(mean(age15to34$LP)),
  sd=c(sd(age15to34$LP)),
  minimum=c(min(age15to34$LP)),
  maximum=c(max(age15to34$LP)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age15to34$LP,surv.time=age15to34$time,surv.event=age15to34$status)$coef),
  D_se=c(D.index(age15to34$LP,surv.time=age15to34$time,surv.event=age15to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```


#### Combine metrics

```{r}
qrisk3_metrics = rbind(metrics_overall,
                       metrics_model0_ageless25,
                       metrics_model0_age25to34,
                       metrics_model0_age35to49,
                       metrics_model0_age15to34,
                       metrics_model0_white,
                       metrics_model0_black,
                       metrics_model0_mixed,
                       metrics_model0_asian,
                       metrics_model0_other)

saveRDS(qrisk3_metrics,"qrisk3_metrics130923_15to49020624 FinalV2.rds")
```


### Overall calibration using pseudo values

```{r}

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

```


#### Mean calibration

```{r}
# Observed / Expected ratio

# Observed
obj <- summary(survfit(
  Surv(time, status) ~ 1, 
  data = vdata),
  times = horizon)

obs_t <- 1 - obj$surv

# Expected
exp_t <- mean(vdata$score)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary = data.frame(OE_summary)
OE_summary$estimate_name = row.names(OE_summary)
OE_summary = OE_summary %>% spread(estimate_name,OE_summary) 

OE_summary$model = "QRISK 3 overall"

OE_summary_QRISK3 = OE_summary

```


#### Weak calibration: Calibration slope and intercept


```{r}
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)

k <- 2
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal = data.frame(res_cal)
res_cal$model = "QRISK3 overall"
res_cal_QRISK3 = res_cal

```



## Recalibrated plots based on baseline hazrd specific to women in our cohort

### Overall calibration using pseudo values

```{r}
# Recalibration of the baseline survival function
recal_mod <- coxph(Surv(validation_data1$time1,validation_data1$status1)~offset(validation_data1$LP))

S10 <- summary(survfit(recal_mod),time=10)$surv
S10

s10_qrisk3_recal = S10

validation_data1$score0 = validation_data1$score
validation_data1$score = (1-(S10^exp(validation_data1$LP-mean(validation_data1$LP))))

```

#### Baseline risk

```{r}

# Extract the baseline hazard function using basehaz
baseline_hazard <- basehaz(recal_mod, centered = FALSE)
# Display the baseline hazard function
print(baseline_hazard)
# Evaluate the baseline hazard at 10 years (3650 days)
# Note: time in the lung dataset is in days
time_point <- 10
baseline_hazard_10yr <- subset(baseline_hazard, time >9.99 & time < 10)$hazard

# Display the 10-year baseline hazard
baseline_hazard_10yr

s10 = 1-baseline_hazard_10yr[1]
s10


k = data.frame(bh=c(s10,s10_qrisk3_recal))
k


s10_qrisk3_recal = s10

validation_data1$score = (1-(s10_qrisk3_recal^exp(validation_data1$LP-mean(validation_data1$LP))))

```


```{r}

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, score, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

```


#### Mean calibration

```{r}
# Observed / Expected ratio

# Observed
obj <- summary(survfit(
  Surv(time, status) ~ 1, 
  data = vdata),
  times = horizon)

obs_t <- 1 - obj$surv

# Expected
exp_t <- mean(vdata$score)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary = data.frame(OE_summary)
OE_summary$estimate_name = row.names(OE_summary)
OE_summary = OE_summary %>% spread(estimate_name,OE_summary) 

OE_summary$model = "QRISK 3 overall Recal"

OE_summary_QRISK3_Recal = OE_summary

```


#### Weak calibration: Calibration slope and intercept


```{r}
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)

k <- 2
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal = data.frame(res_cal)
res_cal$model = "QRISK3 overall Recal"
res_cal_QRISK3_Recal = res_cal

```


## Model 1

### Fractional polynomial for linear predictor

```{r}
# model1_mfp <- mfp(Surv(time,status)~ fp(LP)+pregnancies+ preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption+stillbirth,family = "cox",verbose = T,select = 0.1,data = validation_data1)
# # # # # # # 
# model1_mfp

```

#### Adding the FPs to data

```{r}

validation_data1$LP1 = I((validation_data1$LP+4)^3)
validation_data1$LP2=I((validation_data1$LP+4)^3*log((validation_data1$LP+4)))

```


#### Assessing the polynomials chosen from mfp


```{r}
# Now fit LP using fractional polynomial functions, using df=2 or df=4 option
# to fit FP1 and FP2 respectively.

# FP1 model
LPfp1_mod <- mfp(Surv(time, status)~fp(LP,df=2,alpha=1),family="cox",data=validation_data1,x=TRUE)
LPfp1_mod$fptable

lp_LPfp1 <- predict(LPfp1_mod,type="lp")

# FP2 model
LPfp2_mod <- mfp(Surv(time, status)~fp(LP,df=4,alpha=1),family="cox",data=validation_data1,x=TRUE)
LPfp2_mod$fptable
lp_LPfp2 <- predict(LPfp2_mod,type="lp")

# AIC for models
AIC(LPfp1_mod)
AIC(LPfp2_mod)

# BIC not obtainable from mfp directly, so refit identical model using coxph
LPfp1 <- coxph(Surv(time, status)~log(LP/10),data=validation_data1)
LPfp2 <- coxph(Surv(time, status)~(sqrt(LP))+LP,data=validation_data1)
BIC(LPfp1)
BIC(LPfp2)

LP=subset(validation_data1,!is.na(validation_data1$LP))
LP=LP$LP

# Plot the linear predictor for the FP1 and FP2 functions
data_LPfps <- data.frame(LP,lp_LPfp1,lp_LPfp2)
data_LPfps_m <- melt(data_LPfps,id.vars='LP')


pdf("LP univariable FPs 130923020624 FinalV2.pdf")

p <- ggplot(data_LPfps_m,aes(LP,value,colour=variable))+geom_line()+scale_colour_manual(labels=c("FP1","FP2"),values=c("green","red"))+theme_bw() + labs(x="LP",y="Linear prediction",color="") + theme(legend.position=c(0.2,0.8))

print(p)
dev.off()


```


### Full model

```{r}

model1_fp <- coxph(Surv(time,status)~LP1+LP2+pregnancies+ preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption+stillbirth,method="breslow",data = validation_data1,x=T)

model1_fp_lp <- predict(model1_fp,type="lp")
validation_data1$model1_fp_lp <- predict(model1_fp,type="lp")


model0 <- coxph(Surv(validation_data1$time,validation_data1$status)~validation_data1$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           validation_data1, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = validation_data1$time,
    delta = validation_data1$status,
    marker = validation_data1$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05


#####################################################Calculate risk score for Model 1

s10 <- summary(survfit(model1_fp),time=10)$surv
s10

validation_data1$risk_model1_fp = riskRegression::predictRisk(model1_fp,newdata=validation_data1,times = 10)


###---------Time dependent AUC using riskregression package--------------

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp <- data.frame(
  Model=c("Model 1 fp"),
  Mean=c(mean(validation_data1$model1_fp_lp)),
  sd=c(sd(validation_data1$model1_fp_lp)),
  minimum=c(min(validation_data1$model1_fp_lp)),
  maximum=c(max(validation_data1$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model1_fp)$concordance[1]),
  C_LL=c(summary(model1_fp)$concordance[1]-(1.96*summary(model1_fp)$concordance[2])),
  C_UL=c(summary(model1_fp)$concordance[1]+(1.96*summary(model1_fp)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(validation_data1$model1_fp_lp,surv.time=validation_data1$time,surv.event=validation_data1$status)$coef),
  D_se=c(D.index(validation_data1$model1_fp_lp,surv.time=validation_data1$time,surv.event=validation_data1$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```

<!-- ### LASSO variable selection -->


<!-- #### Data structure -->

<!-- ```{r} -->
<!-- x <- data.matrix(validation_data1[,c("LP1","LP2", -->
<!--   "pregnancies", "preeclampsia","small_for_gest","postnatal_dep","gdm","gest_hyp","miscarriage","preterm_birth","endometriosis","irregular_menses","pcos","Placental_abruption","stillbirth")]) -->

<!-- y <- data.matrix(validation_data1[,c("time","status")]) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- penalty  = c(0,0, -->
<!--              1,1,1,1,1, -->
<!--              1,1,1,1,1, -->
<!--              1,1,1) -->

<!-- penalty -->

<!-- ``` -->


<!-- #### Initial fit -->

<!-- ```{r} -->
<!-- fit <- glmnet(x,y,family = "cox",penalty.factor = penalty,alpha = 1,nlambda = 100,maxit = 1000000) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pdf("lasso_plotM1020624 FinalV2.pdf") -->

<!-- p=plot(fit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- #### Cross validation to obtain optimum lambda -->

<!-- ```{r} -->
<!-- cvfit <- cv.glmnet(x,y,family="cox",penalty.factor = penalty,type.measure = "C",maxit = 1000000) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- pdf("lassoCV_plotM1020624 FinalV2.pdf") -->

<!-- p=plot(cvfit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- ##### Minimum lambda -->

<!-- ```{r} -->
<!-- min=cvfit$lambda.min -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cvfit$lambda.1se -->
<!-- ``` -->


<!-- ```{r} -->
<!-- coef(fit,s=cvfit$lambda.min) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- coef(fit,s=cvfit$lambda.1se) -->
<!-- ``` -->


### Final model (same as full model)

```{r}
model1_fp <- coxph(Surv(time,status)~LP1+LP2+pregnancies+ preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption+stillbirth,method="breslow",data = validation_data1,x=T)

model1_fp_lp <- predict(model1_fp,type="lp")
validation_data1$model1_fp_lp <- predict(model1_fp,type="lp")


model0 <- coxph(Surv(validation_data1$time,validation_data1$status)~validation_data1$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           validation_data1, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = validation_data1$time,
    delta = validation_data1$status,
    marker = validation_data1$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

###---------Time dependent AUC using riskregression package--------------
s10 <- summary(survfit(model1_fp),time=10)$surv
s10

validation_data1$risk_model1_fp = riskRegression::predictRisk(model1_fp,newdata=validation_data1,times = 10)

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp <- data.frame(
  Model=c("Model 1"),
  Mean=c(mean(validation_data1$model1_fp_lp)),
  sd=c(sd(validation_data1$model1_fp_lp)),
  minimum=c(min(validation_data1$model1_fp_lp)),
  maximum=c(max(validation_data1$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  
   C=c(summary(model1_fp)$concordance[1]),
  C_LL=c(summary(model1_fp)$concordance[1]-(1.96*summary(model1_fp)$concordance[2])),
  C_UL=c(summary(model1_fp)$concordance[1]+(1.96*summary(model1_fp)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(validation_data1$model1_fp_lp,surv.time=validation_data1$time,surv.event=validation_data1$status)$coef),
  D_se=c(D.index(validation_data1$model1_fp_lp,surv.time=validation_data1$time,surv.event=validation_data1$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```




```{r}
estimates=tibble::rownames_to_column(data.frame(exp(cbind(HR = coef(model1_fp), 
          confint(model1_fp))),p=summary(model1_fp)$coeff[,5]), "Variables") 

estimatesModel1=estimates %>% mutate_if(is.numeric, round, digits=3)
estimatesModel1$Model = "Model 1"

estimatesModel1$'Model 1 HR (95$ CI)' <- ifelse(is.na(estimatesModel1$X2.5..), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     estimatesModel1$HR, estimatesModel1$X2.5.., estimatesModel1$X97.5..))
estimatesModel1 = estimatesModel1[,c(1,7)]

write.csv(estimatesModel1,"estimatesModel1.csv")

```




### Internal validation

```{r}
# survmod1=with(validation_data1,Surv(time,status))
# 
# cox.mod<-cph(survmod1~LP1+LP2+pregnancies+ preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption,x=T,y=T,surv=TRUE,data = validation_data1)
# 
# cox.mod
# 
# set.seed(3933258)
# boot_1 <- validate(cox.mod,B=200)
# boot_1
# 
# # Note that this gives Dxy rather than c, however Dxy = 2*(c-0.5), i.e. c=(Dxy/2)+0.5
# (boot_1[1,1]+1)/2
# (boot_1[1,5]+1)/2

```


### Performance measures by subgroups


```{r}
s10 <- summary(survfit(model1_fp),time=10)$surv
s10


validation_data1$risk_model1_fp = riskRegression::predictRisk(model1_fp,newdata=validation_data1,times = 10)

s10_model1 = s10

```

#### BASEHAZ

```{r}

#### Baseline risk
# Extract the baseline hazard function using basehaz
baseline_hazard <- basehaz(model1_fp, centered = T)
# Display the baseline hazard function
print(baseline_hazard)
# Evaluate the baseline hazard at 10 years (3650 days)
# Note: time in the lung dataset is in days
time_point <- 10
baseline_hazard_10yr <- subset(baseline_hazard, time >9.99 & time < 10)$hazard

# Display the 10-year baseline hazard
baseline_hazard_10yr

s10 = exp(-baseline_hazard_10yr[1])
s10


k = data.frame(bh=c(s10,s10_model1))
k


s10_model1 = s10

#validation_data1$score = (1-(s10_qrisk3_recal^exp(validation_data1$LP-mean(validation_data1$LP))))

```


```{r}
# Baseline at 10 years
bh <- basehaz(model1_fp, centered = T) # uncentered
bh$surv <- exp(-bh$hazard) # baseline survival
S0_t10 <- bh$surv[bh$time == 10] 
S0_t10

```



#### Ethnicity

##### 1. White

```{r}

#White
white_ethnicity = subset(validation_data1,validation_data1$cprd_white==1)


model0 <- coxph(Surv(white_ethnicity$time,white_ethnicity$status)~white_ethnicity$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           white_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = white_ethnicity$time,
    delta = white_ethnicity$status,
    marker = white_ethnicity$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

#s10 <- summary(survfit(model1_fp),time=10)$surv
#s10

#white_ethnicity$risk_model1_fp = (1-(s10^exp(white_ethnicity$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- white_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_white <- data.frame(
  Model=c("Model 1, White"),
  Mean=c(mean(white_ethnicity$model1_fp_lp)),
  sd=c(sd(white_ethnicity$model1_fp_lp)),
  minimum=c(min(white_ethnicity$model1_fp_lp)),
  maximum=c(max(white_ethnicity$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(white_ethnicity$model1_fp_lp,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$coef),
  D_se=c(D.index(white_ethnicity$model1_fp_lp,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 2. Black

```{r}

black_ethnicity = subset(validation_data1,validation_data1$cprd_black==1)


model0 <- coxph(Surv(black_ethnicity$time,black_ethnicity$status)~black_ethnicity$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           black_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = black_ethnicity$time,
    delta = black_ethnicity$status,
    marker = black_ethnicity$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# black_ethnicity$risk_model1_fp = (1-(s10^exp(black_ethnicity$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- black_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_black <- data.frame(
  Model=c("Model 1, Black"),
  Mean=c(mean(black_ethnicity$model1_fp_lp)),
  sd=c(sd(black_ethnicity$model1_fp_lp)),
  minimum=c(min(black_ethnicity$model1_fp_lp)),
  maximum=c(max(black_ethnicity$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(black_ethnicity$model1_fp_lp,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$coef),
  D_se=c(D.index(black_ethnicity$model1_fp_lp,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 3. Mixed

```{r}

#Mixed
mixed_ethnicity = subset(validation_data1,validation_data1$cprd_mixed==1)

model0 <- coxph(Surv(mixed_ethnicity$time,mixed_ethnicity$status)~mixed_ethnicity$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           mixed_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = mixed_ethnicity$time,
    delta = mixed_ethnicity$status,
    marker = mixed_ethnicity$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# mixed_ethnicity$risk_model1_fp = (1-(s10^exp(mixed_ethnicity$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- mixed_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_mixed <- data.frame(
  Model=c("Model 1, Mixed"),
  Mean=c(mean(mixed_ethnicity$model1_fp_lp)),
  sd=c(sd(mixed_ethnicity$model1_fp_lp)),
  minimum=c(min(mixed_ethnicity$model1_fp_lp)),
  maximum=c(max(mixed_ethnicity$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(mixed_ethnicity$model1_fp_lp,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$coef),
  D_se=c(D.index(mixed_ethnicity$model1_fp_lp,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 4. Asian

```{r}

#asian
asian_ethnicity = subset(validation_data1,validation_data1$cprd_asian==1)

model0 <- coxph(Surv(asian_ethnicity$time,asian_ethnicity$status)~asian_ethnicity$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           asian_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = asian_ethnicity$time,
    delta = asian_ethnicity$status,
    marker = asian_ethnicity$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# asian_ethnicity$risk_model1_fp = (1-(s10^exp(asian_ethnicity$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- asian_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_asian <- data.frame(
  Model=c("Model 1, Asian"),
  Mean=c(mean(asian_ethnicity$model1_fp_lp)),
  sd=c(sd(asian_ethnicity$model1_fp_lp)),
  minimum=c(min(asian_ethnicity$model1_fp_lp)),
  maximum=c(max(asian_ethnicity$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(asian_ethnicity$model1_fp_lp,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$coef),
  D_se=c(D.index(asian_ethnicity$model1_fp_lp,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 5. Other

```{r}

#other
other_ethnicity = subset(validation_data1,validation_data1$cprd_other==1)

model0 <- coxph(Surv(other_ethnicity$time,other_ethnicity$status)~other_ethnicity$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           other_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = other_ethnicity$time,
    delta = other_ethnicity$status,
    marker = other_ethnicity$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# other_ethnicity$risk_model1_fp = (1-(s10^exp(other_ethnicity$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- other_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_other <- data.frame(
  Model=c("Model 1, Other"),
  Mean=c(mean(other_ethnicity$model1_fp_lp)),
  sd=c(sd(other_ethnicity$model1_fp_lp)),
  minimum=c(min(other_ethnicity$model1_fp_lp)),
  maximum=c(max(other_ethnicity$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(other_ethnicity$model1_fp_lp,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$coef),
  D_se=c(D.index(other_ethnicity$model1_fp_lp,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


#### Age

##### 1. <25

```{r}
ageless25 = subset(validation_data1,validation_data1$age_cat=="<25")

model0 <- coxph(Surv(ageless25$time,ageless25$status)~ageless25$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp,
                           ageless25,
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = ageless25$time,
    delta = ageless25$status,
    marker = ageless25$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# ageless25$risk_model1_fp = (1-(s10^exp(ageless25$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- ageless25 %>%
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1)

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_ageless25 <- data.frame(
  Model=c("Model 1, <25"),
  Mean=c(mean(ageless25$model1_fp_lp)),
  sd=c(sd(ageless25$model1_fp_lp)),
  minimum=c(min(ageless25$model1_fp_lp)),
  maximum=c(max(ageless25$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance -
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance +
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),

  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
#
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
#
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(ageless25$model1_fp_lp,surv.time=ageless25$time,surv.event=ageless25$status)$coef),
  D_se=c(D.index(ageless25$model1_fp_lp,surv.time=ageless25$time,surv.event=ageless25$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),

  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))




```


##### 2. 25-34

```{r}
age25to34 = subset(validation_data1,validation_data1$age_cat=="25-34")


model0 <- coxph(Surv(age25to34$time,age25to34$status)~age25to34$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           age25to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age25to34$time,
    delta = age25to34$status,
    marker = age25to34$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# age25to34$risk_model1_fp = (1-(s10^exp(age25to34$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age25to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_age25to34 <- data.frame(
  Model=c("Model 1, 25-34"),
  Mean=c(mean(age25to34$model1_fp_lp)),
  sd=c(sd(age25to34$model1_fp_lp)),
  minimum=c(min(age25to34$model1_fp_lp)),
  maximum=c(max(age25to34$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age25to34$model1_fp_lp,surv.time=age25to34$time,surv.event=age25to34$status)$coef),
  D_se=c(D.index(age25to34$model1_fp_lp,surv.time=age25to34$time,surv.event=age25to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 3. 35-49

```{r}

age35to49 = subset(validation_data1,validation_data1$age_cat=="35-49")



model0 <- coxph(Surv(age35to49$time,age35to49$status)~age35to49$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           age35to49, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age35to49$time,
    delta = age35to49$status,
    marker = age35to49$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# age35to49$risk_model1_fp = (1-(s10^exp(age35to49$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age35to49 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_age35to49 <- data.frame(
  Model=c("Model 1, 35-49"),
  Mean=c(mean(age35to49$model1_fp_lp)),
  sd=c(sd(age35to49$model1_fp_lp)),
  minimum=c(min(age35to49$model1_fp_lp)),
  maximum=c(max(age35to49$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age35to49$model1_fp_lp,surv.time=age35to49$time,surv.event=age35to49$status)$coef),
  D_se=c(D.index(age35to49$model1_fp_lp,surv.time=age35to49$time,surv.event=age35to49$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```

#### 4 <25-34

```{r}

age15to34 = filter(validation_data1,age_cat %in% c("<25","25-34"))


model0 <- coxph(Surv(age15to34$time,age15to34$status)~age15to34$model1_fp_lp,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model1_fp_lp, 
                           age15to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age15to34$time,
    delta = age15to34$status,
    marker = age15to34$model1_fp_lp,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model1_fp),time=10)$surv
# s10
# 
# age15to34$risk_model1_fp = (1-(s10^exp(age15to34$model1_fp_lp)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age15to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model1_fp_age15to34 <- data.frame(
  Model=c("Model 1, 15-34"),
  Mean=c(mean(age15to34$model1_fp_lp)),
  sd=c(sd(age15to34$model1_fp_lp)),
  minimum=c(min(age15to34$model1_fp_lp)),
  maximum=c(max(age15to34$model1_fp_lp)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age15to34$model1_fp_lp,surv.time=age15to34$time,surv.event=age15to34$status)$coef),
  D_se=c(D.index(age15to34$model1_fp_lp,surv.time=age15to34$time,surv.event=age15to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))
```

#### Combine metrics

```{r}

model1_metrics = rbind(metrics_model1_fp,
                       metrics_model1_fp_ageless25,
                       metrics_model1_fp_age25to34,
                       metrics_model1_fp_age35to49,
                       metrics_model1_fp_age15to34,
                       metrics_model1_fp_white,
                       metrics_model1_fp_black,
                       metrics_model1_fp_mixed,
                       metrics_model1_fp_asian,
                       metrics_model1_fp_other)

saveRDS(model1_metrics,"model1_metrics130923_15to49020624 FinalV2.rds")


```

#### Overall calibration using pseudo values - Model 1

```{r}
s10 <- summary(survfit(model1_fp),time=10)$surv
s10


validation_data1$risk_model1_fp = riskRegression::predictRisk(model1_fp,newdata=validation_data1,times = 10)

s10_model1 = s10


validation_data1$risk_model1_fp = riskRegression::predictRisk(model1_fp,validation_data1,times = 10)


```

```{r}

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model1_fp, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

```

#### Mean calibration

```{r}
# Observed / Expected ratio

# Observed
obj <- summary(survfit(
  Surv(time, status) ~ 1, 
  data = vdata),
  times = horizon)

obs_t <- 1 - obj$surv

# Expected
exp_t <- mean(vdata$score)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary = data.frame(OE_summary)
OE_summary$estimate_name = row.names(OE_summary)
OE_summary = OE_summary %>% spread(estimate_name,OE_summary) 

OE_summary$model = "Model 1 overall"

OE_summary_Model1 = OE_summary

```


#### Weak calibration: Calibration slope and intercept


```{r}
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)

k <- 2
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal = data.frame(res_cal)
res_cal$model = "Model 1 overall"
res_cal_Model1 = res_cal

```


```{r}

saveRDS(validation_data1,"UpdatedQRISK3andModel1_MainCorrect.rds")

```



## Model 2a

```{r}
validation_data1$age = validation_data1$age0 #original age
```




```{r}
validation_data1$current_smoker = ifelse(validation_data1$Light_smoker==1,1,ifelse(validation_data1$Heavy_smoker==1,1,ifelse(validation_data1$Moderate_smoker==1,1,0)))

```

```{r}
table(validation_data1$current_smoker)
```

```{r}
table(validation_data1$Light_smoker)
```

```{r}
table(validation_data1$Heavy_smoker)
```

```{r}
table(validation_data1$Moderate_smoker)
```


### Fractional ploynomials

#### CCA only (where BMI and SBP are reported)

```{r}
colMeans(is.na(validation_data1[,c("bmi_inc","sbp_inc")]))

complete_data = subset(validation_data1,!is.na(validation_data1$bmi_inc))
complete_data = subset(complete_data,!is.na(complete_data$sbp_inc))
```



```{r}

# model2_full_mfp_wopc <- mfp(Surv(time,status)~fp(age)+fp(bmi_inc)+fp(sbp_inc)+town+cprd_black+cprd_mixed+cprd_asian+cprd_other+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd,family = "cox",verbose = T,select = 0.1,data = complete_data)
# # # # # # # 
# model2_full_mfp_wopc

```


#### Adding the FPs to data

```{r}
validation_data1$age1 = I((validation_data1$age/10)^1)

validation_data1$bmi1 = I((validation_data1$bmi/10)^1)
#validation_data1$bmi2 = ((validation_data1$bmi/10)^3)*log((validation_data1$bmi/10))


validation_data1$sbp1 = I((validation_data1$sbp/100)^2)
#validation_data1$sbp2 = I(log((validation_data1$sbp/100))^2)
                          
```


#### Assessing the polynomials chosen from mfp

##### SBP

```{r}
# Now fit sbpBs using fractional polynomial functions, using df=2 or df=4 option
# to fit FP1 and FP2 respectively.

# FP1 model
sbpfp1_mod <- mfp(Surv(time, status)~fp(sbp_inc,df=2,alpha=1),family="cox",data=complete_data,x=TRUE)
sbpfp1_mod$fptable

lp_sbpfp1 <- predict(sbpfp1_mod,type="lp")

# FP2 model
sbpfp2_mod <- mfp(Surv(time, status)~fp(sbp_inc,df=4,alpha=1),family="cox",data=complete_data,x=TRUE)
sbpfp2_mod$fptable
lp_sbpfp2 <- predict(sbpfp2_mod,type="lp")

# AIC for models
AIC(sbpfp1_mod)
AIC(sbpfp2_mod)

# BIC not obtainable from mfp directly, so refit identical model using coxph
sbpfp1 <- coxph(Surv(time, status)~log(sbp_inc/10),data=complete_data)
sbpfp2 <- coxph(Surv(time, status)~(sqrt(sbp_inc))+sbp_inc,data=complete_data)
BIC(sbpfp1)
BIC(sbpfp2)

sbpB1=subset(complete_data,!is.na(complete_data$sbp_inc))
sbpB1=sbpB1$sbp_inc

# Plot the linear predictor for the FP1 and FP2 functions
data_sbpFPs <- data.frame(sbpB1,lp_sbpfp1,lp_sbpfp2)
data_sbpFPs_m <- melt(data_sbpFPs,id.vars='sbpB1')

pdf("SBP FPs 130923020624 FinalV2.pdf")

plot_sbpFPs <- ggplot(data_sbpFPs_m,aes(sbpB1,value,colour=variable))+geom_line()+scale_colour_manual(labels=c("FP1","FP2"),values=c("green","red"))+theme_bw() + labs(x="SBP",y="Linear prediction",color="") + theme(legend.position=c(0.2,0.8))

print(plot_sbpFPs)
dev.off()

```

##### BMI

```{r}
# FP1 model
bmifp1_mod <- mfp(Surv(time, status)~fp(bmi_inc,df=2,alpha=1),family="cox",data=complete_data,x=TRUE)
bmifp1_mod$fptable

lp_bmifp1 <- predict(bmifp1_mod,type="lp")

# FP2 model
bmifp2_mod <- mfp(Surv(time, status)~fp(bmi_inc,df=4,alpha=1),family="cox",data=complete_data,x=TRUE)
bmifp2_mod$fptable
lp_bmifp2 <- predict(bmifp2_mod,type="lp")

# AIC for models
AIC(bmifp1_mod)
AIC(bmifp2_mod)

# BIC not obtainable from mfp directly, so refit identical model using coxph
bmifp1 <- coxph(Surv(time, status)~log(bmi_inc/10),data=complete_data)
bmifp2 <- coxph(Surv(time, status)~(sqrt(bmi_inc))+bmi_inc,data=complete_data)
BIC(bmifp1)
BIC(bmifp2)

bmiB1=subset(complete_data,!is.na(complete_data$bmi_inc))
bmiB1=bmiB1$bmi_inc

# Plot the linear predictor for the FP1 and FP2 functions
data_bmiFPs <- data.frame(bmiB1,lp_bmifp1,lp_bmifp2)
data_bmiFPs_m <- melt(data_bmiFPs,id.vars='bmiB1')


pdf("BMI FPs 130923020624 FinalV2.pdf")

plot_bmiFPs <- ggplot(data_bmiFPs_m,aes(bmiB1,value,colour=variable))+geom_line()+scale_colour_manual(labels=c("FP1","FP2"),values=c("green","red"))+theme_bw() + labs(x="bmi",y="Linear prediction",color="") + theme(legend.position=c(0.2,0.8))

print(plot_bmiFPs)
dev.off()


```

<!-- ### LASSO (make sure white and non-smoker are refs and hence not included in predictors matrix) -->

<!-- #### Data structure -->

<!-- ```{r} -->
<!-- x <- data.matrix(validation_data1[,c("age1","bmi1","sbp1","town", "cprd_black", "cprd_mixed", "cprd_asian", "cprd_other","Ex_smoker","current_smoker","b_AF","b_atypicalantipsy","b_corticosteroids","b_migraine","b_ra","b_renal","b_semi","b_sle","b_treatedhyp","b_type1","b_type2","fh_cvd")]) -->

<!-- y <- data.matrix(validation_data1[,c("time","status")]) -->

<!-- ``` -->

<!-- #### Initial fit -->

<!-- ```{r} -->
<!-- fit <- glmnet(x,y,family = "cox",alpha = 1,nlambda = 100) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pdf("lasso_plotM2a020624 FinalV2.pdf") -->

<!-- p=plot(fit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- #### Cross validation to obtain optimum lambda -->

<!-- ```{r} -->
<!-- cvfit <- cv.glmnet(x,y,family="cox",type.measure = "C") -->
<!-- ``` -->


<!-- ```{r} -->
<!-- pdf("lassoCV_plotM2a020624 FinalV2.pdf") -->

<!-- p=plot(cvfit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- ##### Minimum lambda -->

<!-- ```{r} -->
<!-- min=cvfit$lambda.min -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cvfit$lambda.1se -->
<!-- ``` -->


<!-- ```{r} -->
<!-- coef(fit,s=cvfit$lambda.min) -->
<!-- ``` -->



### Final model

```{r}

model2_lasso <- coxph(Surv(time,status)~age1+bmi1+sbp1+town+cprd_black+cprd_mixed+cprd_asian+cprd_other+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd,method="breslow",data = validation_data1,x=T)


validation_data1$model2_lasso_lp_wopc <- predict(model2_lasso,type="lp")

model0 <- coxph(Surv(validation_data1$time,validation_data1$status)~validation_data1$model2_lasso_lp_wopc,method="breslow")



Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           validation_data1, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = validation_data1$time,
    delta = validation_data1$status,
    marker = validation_data1$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

s10 <- summary(survfit(model2_lasso),time=10)$surv
s10

validation_data1$risk_model2_lasso = riskRegression::predictRisk(model2_lasso,newdata=validation_data1,times = 10)

#validation_data1$risk_model2_lasso = riskRegression::predictRisk(model2_lasso,newdata=validation_data1,times = 10)



###---------Time dependent AUC using riskregression package--------------

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso <- data.frame(
  Model=c("Model 2a"),
  Mean=c(mean(validation_data1$model2_lasso_lp_wopc)),
  sd=c(sd(validation_data1$model2_lasso_lp_wopc)),
  minimum=c(min(validation_data1$model2_lasso_lp_wopc)),
  maximum=c(max(validation_data1$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  
  C=c(summary(model2_lasso)$concordance[1]),
  C_LL=c(summary(model2_lasso)$concordance[1]-(1.96*summary(model2_lasso)$concordance[2])),
  C_UL=c(summary(model2_lasso)$concordance[1]+(1.96*summary(model2_lasso)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(validation_data1$model2_lasso_lp_wopc,surv.time=validation_data1$time,surv.event=validation_data1$status)$coef),
  D_se=c(D.index(validation_data1$model2_lasso_lp_wopc,surv.time=validation_data1$time,surv.event=validation_data1$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```




```{r}
estimates=tibble::rownames_to_column(data.frame(exp(cbind(HR = coef(model2_lasso), 
          confint(model2_lasso))),p=summary(model2_lasso)$coeff[,5]), "Variables") 

estimatesModel2a=estimates %>% mutate_if(is.numeric, round, digits=3)
estimatesModel2a$Model = "Model 2a"

estimatesModel2a$'Model 2a HR (95$ CI)' <- ifelse(is.na(estimatesModel2a$X2.5..), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     estimatesModel2a$HR, estimatesModel2a$X2.5.., estimatesModel2a$X97.5..))
estimatesModel2a = estimatesModel2a[,c(1,7)]

write.csv(estimatesModel2a,"estimatesModel2a.csv")

```



### Internal validation

```{r}
# survmod1=with(validation_data1,Surv(time,status))
# 
# cox.mod<-cph(survmod1~age1+bmi1+sbp1+town+cprd_white+cprd_black+cprd_mixed+cprd_asian+cprd_other+Non_smoker+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd,x=T,y=T,surv=TRUE,data = validation_data1)
# 
# cox.mod
# 
# set.seed(3933258)
# boot_1 <- validate(cox.mod,B=200)
# boot_1
# 
# # Note that this gives Dxy rather than c, however Dxy = 2*(c-0.5), i.e. c=(Dxy/2)+0.5
# (boot_1[1,1]+1)/2
# (boot_1[1,5]+1)/2

```



### Performance measures by subgroups

#### Ethnicity

##### 1. White

```{r}

#White
white_ethnicity = subset(validation_data1,validation_data1$cprd_white==1)

model0 <- coxph(Surv(white_ethnicity$time,white_ethnicity$status)~white_ethnicity$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           white_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = white_ethnicity$time,
    delta = white_ethnicity$status,
    marker = white_ethnicity$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# white_ethnicity$risk_model2_lasso = (1-(s10^exp(white_ethnicity$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- white_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_white <- data.frame(
  Model=c("Model 2a, White"),
  Mean=c(mean(white_ethnicity$model2_lasso_lp_wopc)),
  sd=c(sd(white_ethnicity$model2_lasso_lp_wopc)),
  minimum=c(min(white_ethnicity$model2_lasso_lp_wopc)),
  maximum=c(max(white_ethnicity$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(white_ethnicity$model2_lasso_lp_wopc,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$coef),
  D_se=c(D.index(white_ethnicity$model2_lasso_lp_wopc,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 2. Black

```{r}

black_ethnicity = subset(validation_data1,validation_data1$cprd_black==1)


model0 <- coxph(Surv(black_ethnicity$time,black_ethnicity$status)~black_ethnicity$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           black_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = black_ethnicity$time,
    delta = black_ethnicity$status,
    marker = black_ethnicity$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# black_ethnicity$risk_model2_lasso = (1-(s10^exp(black_ethnicity$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- black_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_black <- data.frame(
  Model=c("Model 2a,Black"),
  Mean=c(mean(black_ethnicity$model2_lasso_lp_wopc)),
  sd=c(sd(black_ethnicity$model2_lasso_lp_wopc)),
  minimum=c(min(black_ethnicity$model2_lasso_lp_wopc)),
  maximum=c(max(black_ethnicity$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(black_ethnicity$model2_lasso_lp_wopc,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$coef),
  D_se=c(D.index(black_ethnicity$model2_lasso_lp_wopc,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 3. Mixed

```{r}

#Mixed
mixed_ethnicity = subset(validation_data1,validation_data1$cprd_mixed==1)

model0 <- coxph(Surv(mixed_ethnicity$time,mixed_ethnicity$status)~mixed_ethnicity$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           mixed_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = mixed_ethnicity$time,
    delta = mixed_ethnicity$status,
    marker = mixed_ethnicity$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# mixed_ethnicity$risk_model2_lasso = (1-(s10^exp(mixed_ethnicity$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- mixed_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_mixed <- data.frame(
  Model=c("Model 2a, Mixed"),
  Mean=c(mean(mixed_ethnicity$model2_lasso_lp_wopc)),
  sd=c(sd(mixed_ethnicity$model2_lasso_lp_wopc)),
  minimum=c(min(mixed_ethnicity$model2_lasso_lp_wopc)),
  maximum=c(max(mixed_ethnicity$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(mixed_ethnicity$model2_lasso_lp_wopc,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$coef),
  D_se=c(D.index(mixed_ethnicity$model2_lasso_lp_wopc,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 4. Asian

```{r}

#asian
asian_ethnicity = subset(validation_data1,validation_data1$cprd_asian==1)

model0 <- coxph(Surv(asian_ethnicity$time,asian_ethnicity$status)~asian_ethnicity$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           asian_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = asian_ethnicity$time,
    delta = asian_ethnicity$status,
    marker = asian_ethnicity$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# asian_ethnicity$risk_model2_lasso = (1-(s10^exp(asian_ethnicity$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- asian_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_asian <- data.frame(
  Model=c("Model 2a, Asian"),
  Mean=c(mean(asian_ethnicity$model2_lasso_lp_wopc)),
  sd=c(sd(asian_ethnicity$model2_lasso_lp_wopc)),
  minimum=c(min(asian_ethnicity$model2_lasso_lp_wopc)),
  maximum=c(max(asian_ethnicity$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(asian_ethnicity$model2_lasso_lp_wopc,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$coef),
  D_se=c(D.index(asian_ethnicity$model2_lasso_lp_wopc,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 5. Other

```{r}

#other
other_ethnicity = subset(validation_data1,validation_data1$cprd_other==1)

model0 <- coxph(Surv(other_ethnicity$time,other_ethnicity$status)~other_ethnicity$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           other_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = other_ethnicity$time,
    delta = other_ethnicity$status,
    marker = other_ethnicity$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# other_ethnicity$risk_model2_lasso = (1-(s10^exp(other_ethnicity$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- other_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_other <- data.frame(
  Model=c("Model 2a, Other"),
  Mean=c(mean(other_ethnicity$model2_lasso_lp_wopc)),
  sd=c(sd(other_ethnicity$model2_lasso_lp_wopc)),
  minimum=c(min(other_ethnicity$model2_lasso_lp_wopc)),
  maximum=c(max(other_ethnicity$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(other_ethnicity$model2_lasso_lp_wopc,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$coef),
  D_se=c(D.index(other_ethnicity$model2_lasso_lp_wopc,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


#### Age

##### 1. <25

```{r}
ageless25 = subset(validation_data1,validation_data1$age_cat=="<25")

model0 <- coxph(Surv(ageless25$time,ageless25$status)~ageless25$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc,
                           ageless25,
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = ageless25$time,
    delta = ageless25$status,
    marker = ageless25$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# ageless25$risk_model2_lasso = (1-(s10^exp(ageless25$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- ageless25 %>%
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1)

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_ageless25 <- data.frame(
  Model=c("Model 2a, <25"),
  Mean=c(mean(ageless25$model2_lasso_lp_wopc)),
  sd=c(sd(ageless25$model2_lasso_lp_wopc)),
  minimum=c(min(ageless25$model2_lasso_lp_wopc)),
  maximum=c(max(ageless25$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance -
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance +
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),

  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
#
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
#
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(ageless25$model2_lasso_lp_wopc,surv.time=ageless25$time,surv.event=ageless25$status)$coef),
  D_se=c(D.index(ageless25$model2_lasso_lp_wopc,surv.time=ageless25$time,surv.event=ageless25$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),

  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))




```


##### 2. 25-34

```{r}
age25to34 = subset(validation_data1,validation_data1$age_cat=="25-34")

model0 <- coxph(Surv(age25to34$time,age25to34$status)~age25to34$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           age25to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age25to34$time,
    delta = age25to34$status,
    marker = age25to34$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# age25to34$risk_model2_lasso = (1-(s10^exp(age25to34$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age25to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_age25to34 <- data.frame(
  Model=c("Model 2a, 25-34"),
  Mean=c(mean(age25to34$model2_lasso_lp_wopc)),
  sd=c(sd(age25to34$model2_lasso_lp_wopc)),
  minimum=c(min(age25to34$model2_lasso_lp_wopc)),
  maximum=c(max(age25to34$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age25to34$model2_lasso_lp_wopc,surv.time=age25to34$time,surv.event=age25to34$status)$coef),
  D_se=c(D.index(age25to34$model2_lasso_lp_wopc,surv.time=age25to34$time,surv.event=age25to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 3. 35-49

```{r}

age35to49 = subset(validation_data1,validation_data1$age_cat=="35-49")


model0 <- coxph(Surv(age35to49$time,age35to49$status)~age35to49$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           age35to49, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age35to49$time,
    delta = age35to49$status,
    marker = age35to49$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# age35to49$risk_model2_lasso = (1-(s10^exp(age35to49$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age35to49 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_age35to49 <- data.frame(
  Model=c("Model 2a, 35-49"),
  Mean=c(mean(age35to49$model2_lasso_lp_wopc)),
  sd=c(sd(age35to49$model2_lasso_lp_wopc)),
  minimum=c(min(age35to49$model2_lasso_lp_wopc)),
  maximum=c(max(age35to49$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age35to49$model2_lasso_lp_wopc,surv.time=age35to49$time,surv.event=age35to49$status)$coef),
  D_se=c(D.index(age35to49$model2_lasso_lp_wopc,surv.time=age35to49$time,surv.event=age35to49$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```


##### 4. <25-34

```{r}

age15to34 = filter(validation_data1,age_cat %in% c("<25","25-34"))

model0 <- coxph(Surv(age15to34$time,age15to34$status)~age15to34$model2_lasso_lp_wopc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wopc, 
                           age15to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age15to34$time,
    delta = age15to34$status,
    marker = age15to34$model2_lasso_lp_wopc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 2a

# s10 <- summary(survfit(model2_lasso),time=10)$surv
# s10
# 
# age15to34$risk_model2_lasso = (1-(s10^exp(age15to34$model2_lasso_lp_wopc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age15to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_age15to34 <- data.frame(
  Model=c("Model 2a, 15-34"),
  Mean=c(mean(age15to34$model2_lasso_lp_wopc)),
  sd=c(sd(age15to34$model2_lasso_lp_wopc)),
  minimum=c(min(age15to34$model2_lasso_lp_wopc)),
  maximum=c(max(age15to34$model2_lasso_lp_wopc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age15to34$model2_lasso_lp_wopc,surv.time=age15to34$time,surv.event=age15to34$status)$coef),
  D_se=c(D.index(age15to34$model2_lasso_lp_wopc,surv.time=age15to34$time,surv.event=age15to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```



##### Combine metrics

```{r}

model2a_metrics = rbind(metrics_model2_lasso,
                       metrics_model2_lasso_ageless25,
                       metrics_model2_lasso_age25to34,
                       metrics_model2_lasso_age35to49,
                       metrics_model2_lasso_age15to34,
                       metrics_model2_lasso_white,
                       metrics_model2_lasso_black,
                       metrics_model2_lasso_mixed,
                       metrics_model2_lasso_asian,
                       metrics_model2_lasso_other)

saveRDS(model2a_metrics,"model2a_metrics130923_15to49020624 FinalV2.rds")

```


### Overall calibration using pseudo values - Model 2a

```{r}

validation_data1$model2_lasso_lp_wopc <- predict(model2_lasso,type="lp")

s10 <- summary(survfit(model2_lasso),time=10)$surv
s10

validation_data1$risk_model2_lasso = riskRegression::predictRisk(model2_lasso,newdata=validation_data1,times = 10)

s10_model2a=s10
validation_data1$risk_model2_lasso = riskRegression::predictRisk(model2_lasso,validation_data1,times = 10)

```



```{r}

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

```


#### Mean calibration

```{r}
# Observed / Expected ratio

# Observed
obj <- summary(survfit(
  Surv(time, status) ~ 1, 
  data = vdata),
  times = horizon)

obs_t <- 1 - obj$surv

# Expected
exp_t <- mean(vdata$score)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary = data.frame(OE_summary)
OE_summary$estimate_name = row.names(OE_summary)
OE_summary = OE_summary %>% spread(estimate_name,OE_summary) 

OE_summary$model = "Model 2a overall"

OE_summary_Model2a = OE_summary

```


#### Weak calibration: Calibration slope and intercept


```{r}
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)

k <- 2
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal = data.frame(res_cal)
res_cal$model = "Model 2a overall"
res_cal_Model2a = res_cal

```


## Model 2b

### Fractional ploynomials

#### CCA only (where BMI and SBP are reported)

```{r}

model2_full_mfp_wopc <- mfp(Surv(time,status)~fp(age)+fp(bmi_inc)+fp(sbp_inc)+town+cprd_black+cprd_mixed+cprd_asian+cprd_other+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd+preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption+stillbirth,family = "cox",verbose = T,select = 0.1,data = complete_data)
# # # # # 
model2_full_mfp_wopc

```


#### Adding the FPs to data

```{r}
validation_data1$age1 = I((validation_data1$age/10)^1)

validation_data1$bmi1 = I((validation_data1$bmi/10)^1)
#validation_data1$bmi2 = ((validation_data1$bmi/10)^3)*log((validation_data1$bmi/10))


validation_data1$sbp1 = I((validation_data1$sbp/100)^2)
#validation_data1$sbp2 = I(log((validation_data1$sbp/100))^2)
                          
```


<!-- #### LASSO -->

<!-- #### Data structure -->

<!-- ```{r} -->
<!-- x <- data.matrix(validation_data1[,c("age1","bmi1","sbp1","town","cprd_black", "cprd_mixed", "cprd_asian", "cprd_other","Ex_smoker","current_smoker","b_AF","b_atypicalantipsy","b_corticosteroids","b_migraine","b_ra","b_renal","b_semi","b_sle","b_treatedhyp","b_type1","b_type2","fh_cvd", -->

<!--                                      "preeclampsia","small_for_gest","postnatal_dep","gdm","gest_hyp","miscarriage","preterm_birth","endometriosis","irregular_menses","pcos","Placental_abruption","stillbirth","pregnancies")]) -->

<!-- y <- data.matrix(validation_data1[,c("time","status")]) -->

<!-- ``` -->



<!-- ```{r} -->
<!-- penalty  = c(0,0,0,0,0, -->
<!--              0,0,0,0,0, -->
<!--              0,0,0,0,0, -->
<!--              0,0,0,0,0, -->
<!--              0,0, -->
<!--              1,1,1,1,1,1, -->
<!--              1,1,1,1,1, -->
<!--              1,1) -->
<!-- ``` -->


<!-- #### Initial fit -->

<!-- ```{r} -->
<!-- fit <- glmnet(x,y,family = "cox",penalty.factor = penalty,alpha = 1,nlambda = 100, maxit = 10000000) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- pdf("lasso_plotM2b020624 FinalV2.pdf") -->

<!-- p=plot(fit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- #### Cross validation to obtain optimum lambda -->

<!-- ```{r} -->
<!-- cvfit <- cv.glmnet(x,y,family="cox",penalty.factor = penalty,type.measure = "C",maxit = 10000000) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- pdf("lassoCV_plotM2b020624 FinalV2.pdf") -->

<!-- p=plot(cvfit) -->

<!-- print(p) -->
<!-- dev.off() -->
<!-- ``` -->

<!-- ##### Minimum lambda -->

<!-- ```{r} -->
<!-- min=cvfit$lambda.min -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cvfit$lambda.1se -->
<!-- ``` -->


<!-- ```{r} -->
<!-- coef(fit,s=cvfit$lambda.min) -->
<!-- ``` -->




### Final model

```{r}

model2_lasso_wipcs <- coxph(Surv(time,status)~age1+bmi1+sbp1+town+pregnancies+cprd_black+cprd_mixed+cprd_asian+cprd_other+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd+preeclampsia+postnatal_dep+gdm+gest_hyp+miscarriage+endometriosis+pcos+stillbirth,method="breslow",data = validation_data1,x=T)
# 
validation_data1$model2_lasso_lp_wipc <- predict(model2_lasso_wipcs,type="lp")

model0 <- coxph(Surv(validation_data1$time,validation_data1$status)~validation_data1$model2_lasso_lp_wipc,method="breslow")


Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           validation_data1, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = validation_data1$time,
    delta = validation_data1$status,
    marker = validation_data1$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

###---------Time dependent AUC using riskregression package--------------

#####################################################Calculate risk score for Model 1

s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
s10


#validation_data1$risk_model2_lasso_wipcs = riskRegression::predictRisk(model2_lasso_wipcs,newdata=validation_data1,times = 10)
validation_data1$risk_model2_lasso_wipcs = riskRegression::predictRisk(model2_lasso_wipcs,newdata=validation_data1,times = 10)

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs <- data.frame(
  Model=c("Model 2b"),
  Mean=c(mean(validation_data1$model2_lasso_lp_wipc)),
  sd=c(sd(validation_data1$model2_lasso_lp_wipc)),
  minimum=c(min(validation_data1$model2_lasso_lp_wipc)),
  maximum=c(max(validation_data1$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model2_lasso_wipcs)$concordance[1]),
  C_LL=c(summary(model2_lasso_wipcs)$concordance[1]-(1.96*summary(model2_lasso_wipcs)$concordance[2])),
  C_UL=c(summary(model2_lasso_wipcs)$concordance[1]+(1.96*summary(model2_lasso_wipcs)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(validation_data1$model2_lasso_lp_wipc,surv.time=validation_data1$time,surv.event=validation_data1$status)$coef),
  D_se=c(D.index(validation_data1$model2_lasso_lp_wipc,surv.time=validation_data1$time,surv.event=validation_data1$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



```{r}
estimates=tibble::rownames_to_column(data.frame(exp(cbind(HR = coef(model2_lasso_wipcs), 
          confint(model2_lasso_wipcs))),p=summary(model2_lasso_wipcs)$coeff[,5]), "Variables") 

estimatesModel2b=estimates %>% mutate_if(is.numeric, round, digits=3)
estimatesModel2b$Model = "Model 2b"


estimatesModel2b$'Model 2b HR (95$ CI)' <- ifelse(is.na(estimatesModel2b$X2.5..), "",
                             sprintf("%.2f (%.2f to %.2f)",
                                     estimatesModel2b$HR, estimatesModel2b$X2.5.., estimatesModel2b$X97.5..))
estimatesModel2b = estimatesModel2b[,c(1,7)]

write.csv(estimatesModel2b,"estimatesModel2b.csv")

```


### Internal validation

```{r}
# survmod1=with(validation_data1,Surv(time,status))
# # 
# cox.mod<-cph(survmod1~age1+bmi1+sbp1+town+pregnancies+cprd_white+cprd_black+cprd_mixed+cprd_asian+cprd_other+Non_smoker+Ex_smoker+current_smoker+b_AF+b_atypicalantipsy+b_corticosteroids+b_migraine+b_ra+b_renal+b_semi+b_sle+b_treatedhyp+b_type1+b_type2+fh_cvd+preeclampsia+small_for_gest+postnatal_dep+gdm+gest_hyp+miscarriage+preterm_birth+endometriosis+irregular_menses+pcos+ Placental_abruption,x=T,y=T,surv=TRUE,data = validation_data1)
# # 
# cox.mod
# # 
# set.seed(3933258)
# boot_1 <- validate(cox.mod,B=200)
# boot_1
# # 
# # Note that this gives Dxy rather than c, however Dxy = 2*(c-0.5), i.e. c=(Dxy/2)+0.5
# (boot_1[1,1]+1)/2
# (boot_1[1,5]+1)/2

```


### Performance measures by subgroups

#### Ethnicity

##### 1. White

```{r}

#White
white_ethnicity = subset(validation_data1,validation_data1$cprd_white==1)


model0 <- coxph(Surv(white_ethnicity$time,white_ethnicity$status)~white_ethnicity$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           white_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = white_ethnicity$time,
    delta = white_ethnicity$status,
    marker = white_ethnicity$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# white_ethnicity$risk_model2_lasso_wipcs = (1-(s10^exp(white_ethnicity$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- white_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_white <- data.frame(
  Model=c("Model 2b, White"),
  Mean=c(mean(white_ethnicity$model2_lasso_lp_wipc)),
  sd=c(sd(white_ethnicity$model2_lasso_lp_wipc)),
  minimum=c(min(white_ethnicity$model2_lasso_lp_wipc)),
  maximum=c(max(white_ethnicity$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(white_ethnicity$model2_lasso_lp_wipc,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$coef),
  D_se=c(D.index(white_ethnicity$model2_lasso_lp_wipc,surv.time=white_ethnicity$time,surv.event=white_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 2. Black

```{r}

black_ethnicity = subset(validation_data1,validation_data1$cprd_black==1)


model0 <- coxph(Surv(black_ethnicity$time,black_ethnicity$status)~black_ethnicity$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           black_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = black_ethnicity$time,
    delta = black_ethnicity$status,
    marker = black_ethnicity$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# black_ethnicity$risk_model2_lasso_wipcs = (1-(s10^exp(black_ethnicity$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- black_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_black <- data.frame(
  Model=c("Model 2b, Black"),
  Mean=c(mean(black_ethnicity$model2_lasso_lp_wipc)),
  sd=c(sd(black_ethnicity$model2_lasso_lp_wipc)),
  minimum=c(min(black_ethnicity$model2_lasso_lp_wipc)),
  maximum=c(max(black_ethnicity$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(black_ethnicity$model2_lasso_lp_wipc,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$coef),
  D_se=c(D.index(black_ethnicity$model2_lasso_lp_wipc,surv.time=black_ethnicity$time,surv.event=black_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 3. Mixed

```{r}

#Mixed
mixed_ethnicity = subset(validation_data1,validation_data1$cprd_mixed==1)

model0 <- coxph(Surv(mixed_ethnicity$time,mixed_ethnicity$status)~mixed_ethnicity$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           mixed_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = mixed_ethnicity$time,
    delta = mixed_ethnicity$status,
    marker = mixed_ethnicity$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# mixed_ethnicity$risk_model2_lasso_wipcs = (1-(s10^exp(mixed_ethnicity$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- mixed_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_mixed <- data.frame(
  Model=c("Model 2b, Mixed"),
  Mean=c(mean(mixed_ethnicity$model2_lasso_lp_wipc)),
  sd=c(sd(mixed_ethnicity$model2_lasso_lp_wipc)),
  minimum=c(min(mixed_ethnicity$model2_lasso_lp_wipc)),
  maximum=c(max(mixed_ethnicity$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(mixed_ethnicity$model2_lasso_lp_wipc,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$coef),
  D_se=c(D.index(mixed_ethnicity$model2_lasso_lp_wipc,surv.time=mixed_ethnicity$time,surv.event=mixed_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 4. Asian

```{r}

#asian
asian_ethnicity = subset(validation_data1,validation_data1$cprd_asian==1)

model0 <- coxph(Surv(asian_ethnicity$time,asian_ethnicity$status)~asian_ethnicity$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           asian_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = asian_ethnicity$time,
    delta = asian_ethnicity$status,
    marker = asian_ethnicity$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# asian_ethnicity$risk_model2_lasso_wipcs = (1-(s10^exp(asian_ethnicity$model2_lasso_lp_wipc)))
# 
# ###---------Time dependent AUC using riskregression package--------------

vdata <- asian_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_asian <- data.frame(
  Model=c("Model 2b, Asian"),
  Mean=c(mean(asian_ethnicity$model2_lasso_lp_wipc)),
  sd=c(sd(asian_ethnicity$model2_lasso_lp_wipc)),
  minimum=c(min(asian_ethnicity$model2_lasso_lp_wipc)),
  maximum=c(max(asian_ethnicity$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(asian_ethnicity$model2_lasso_lp_wipc,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$coef),
  D_se=c(D.index(asian_ethnicity$model2_lasso_lp_wipc,surv.time=asian_ethnicity$time,surv.event=asian_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```



##### 5. Other

```{r}

#other
other_ethnicity = subset(validation_data1,validation_data1$cprd_other==1)

model0 <- coxph(Surv(other_ethnicity$time,other_ethnicity$status)~other_ethnicity$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           other_ethnicity, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = other_ethnicity$time,
    delta = other_ethnicity$status,
    marker = other_ethnicity$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# other_ethnicity$risk_model2_lasso_wipcs = (1-(s10^exp(other_ethnicity$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- other_ethnicity %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_other <- data.frame(
  Model=c("Model 2b, Other"),
  Mean=c(mean(other_ethnicity$model2_lasso_lp_wipc)),
  sd=c(sd(other_ethnicity$model2_lasso_lp_wipc)),
  minimum=c(min(other_ethnicity$model2_lasso_lp_wipc)),
  maximum=c(max(other_ethnicity$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(other_ethnicity$model2_lasso_lp_wipc,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$coef),
  D_se=c(D.index(other_ethnicity$model2_lasso_lp_wipc,surv.time=other_ethnicity$time,surv.event=other_ethnicity$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


#### Age

##### 1. <25

```{r}
ageless25 = subset(validation_data1,validation_data1$age_cat=="<25")

model0 <- coxph(Surv(ageless25$time,ageless25$status)~ageless25$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc,
                           ageless25,
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = ageless25$time,
    delta = ageless25$status,
    marker = ageless25$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# ageless25$risk_model2_lasso_wipcs = (1-(s10^exp(ageless25$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- ageless25 %>%
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1)

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_ageless25 <- data.frame(
  Model=c("Model 2b, < 25"),
  Mean=c(mean(ageless25$model2_lasso_lp_wipc)),
  sd=c(sd(ageless25$model2_lasso_lp_wipc)),
  minimum=c(min(ageless25$model2_lasso_lp_wipc)),
  maximum=c(max(ageless25$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance -
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance +
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),

  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
#
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
#
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(ageless25$model2_lasso_lp_wipc,surv.time=ageless25$time,surv.event=ageless25$status)$coef),
  D_se=c(D.index(ageless25$model2_lasso_lp_wipc,surv.time=ageless25$time,surv.event=ageless25$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),

  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))




```


##### 2. 25-34

```{r}
age25to34 = subset(validation_data1,validation_data1$age_cat=="25-34")

model0 <- coxph(Surv(age25to34$time,age25to34$status)~age25to34$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           age25to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age25to34$time,
    delta = age25to34$status,
    marker = age25to34$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# age25to34$risk_model2_lasso_wipcs = (1-(s10^exp(age25to34$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age25to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_age25to34 <- data.frame(
  Model=c("Model 2b, 25-34"),
  Mean=c(mean(age25to34$model2_lasso_lp_wipc)),
  sd=c(sd(age25to34$model2_lasso_lp_wipc)),
  minimum=c(min(age25to34$model2_lasso_lp_wipc)),
  maximum=c(max(age25to34$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age25to34$model2_lasso_lp_wipc,surv.time=age25to34$time,surv.event=age25to34$status)$coef),
  D_se=c(D.index(age25to34$model2_lasso_lp_wipc,surv.time=age25to34$time,surv.event=age25to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```


##### 3. 35-49

```{r}

age35to49 = subset(validation_data1,validation_data1$age_cat=="35-49")


model0 <- coxph(Surv(age35to49$time,age35to49$status)~age35to49$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           age35to49, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age35to49$time,
    delta = age35to49$status,
    marker = age35to49$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# age35to49$risk_model2_lasso_wipcs = (1-(s10^exp(age35to49$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age35to49 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_age35to49 <- data.frame(
  Model=c("Model 2b, 35-49"),
  Mean=c(mean(age35to49$model2_lasso_lp_wipc)),
  sd=c(sd(age35to49$model2_lasso_lp_wipc)),
  minimum=c(min(age35to49$model2_lasso_lp_wipc)),
  maximum=c(max(age35to49$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age35to49$model2_lasso_lp_wipc,surv.time=age35to49$time,surv.event=age35to49$status)$coef),
  D_se=c(D.index(age35to49$model2_lasso_lp_wipc,surv.time=age35to49$time,surv.event=age35to49$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))

```


##### 4. <25-34

```{r}

age15to34 = filter(validation_data1,age_cat %in% c("<25","25-34"))

model0 <- coxph(Surv(age15to34$time,age15to34$status)~age15to34$model2_lasso_lp_wipc,method="breslow")

Uno_C = concordance(Surv(time,status) ~ model2_lasso_lp_wipc, 
                           age15to34, 
                           reverse = TRUE,
                           timewt = "n/G2")
Uno_TD <-
  timeROC::timeROC(
    T = age15to34$time,
    delta = age15to34$status,
    marker = age15to34$model2_lasso_lp_wipc,
    cause = 1,
    weighting = "marginal",
    times = 9.99,
    iid = F
  )

alpha <- .05

#####################################################Calculate risk score for Model 1

# s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
# s10
# 
# age15to34$risk_model2_lasso_wipcs = (1-(s10^exp(age15to34$model2_lasso_lp_wipc)))

###---------Time dependent AUC using riskregression package--------------

vdata <- age15to34 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)

# Validation data
score_vdata <- Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  metrics = c("auc"),
  cause = primary_event,
  plots = "calibration"
)

##########-----------------------------------------------------------

kap <- sqrt(8/pi)
sig2 <- (pi^2)/6

metrics_model2_lasso_wipcs_age15to34 <- data.frame(
  Model=c("Model 2b, 15-34"),
  Mean=c(mean(age15to34$model2_lasso_lp_wipc)),
  sd=c(sd(age15to34$model2_lasso_lp_wipc)),
  minimum=c(min(age15to34$model2_lasso_lp_wipc)),
  maximum=c(max(age15to34$model2_lasso_lp_wipc)),
  Calibration_slope = model0$coef,Calibration_slopeLL=model0$coef-qnorm(1 - alpha / 2) * sqrt(model0$var),Calibration_slopeUL=model0$coef+qnorm(1 - alpha / 2) * sqrt(model0$var),
  C=c(summary(model0)$concordance[1]),
  C_LL=c(summary(model0)$concordance[1]-(1.96*summary(model0)$concordance[2])),
  C_UL=c(summary(model0)$concordance[1]+(1.96*summary(model0)$concordance[2])),

  UnosC=Uno_C$concordance,
  UnosC_LL=Uno_C$concordance - 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var) ,
  UnosC_UL=Uno_C$concordance + 
    qnorm(1 - alpha / 2) * sqrt(Uno_C$var),
  
  # Uno's time-dependent Area Under the Curve
Uno_TD_C=Uno_TD$AUC["t=9.99"],
# 
# Uno_TD_C_LL=Uno_TD$AUC["t=9.99"] -
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"],
# 
# Uno_TD_C_UL=Uno_TD$AUC["t=9.99"] +
#     qnorm(1 - alpha / 2) * Uno_TD$inference$vect_sd_1["t=9.99"]
TD_AUC = score_vdata$AUC$score$AUC,
  TD_AUC_LL = score_vdata$AUC$score$AUC - qnorm(1 - alpha / 2) * score_vdata$AUC$score$se,
  TD_AUC_UL = score_vdata$AUC$score$AUC + qnorm(1 - alpha / 2) * score_vdata$AUC$score$se
  ) %>%
  dplyr::mutate(
  D=c(D.index(age15to34$model2_lasso_lp_wipc,surv.time=age15to34$time,surv.event=age15to34$status)$coef),
  D_se=c(D.index(age15to34$model2_lasso_lp_wipc,surv.time=age15to34$time,surv.event=age15to34$status)$se),
  D_LL=c(D-(1.96*D_se)),
  D_UL=c(D+(1.96*D_se)),
  
  R2D=c((D^2 / kap^2) / (sig2 + (D^2 / kap^2))))


```

##### Combine metrics

```{r}

model2b_metrics = rbind(metrics_model2_lasso_wipcs,
                       metrics_model2_lasso_wipcs_ageless25,
                       metrics_model2_lasso_wipcs_age25to34,
                       metrics_model2_lasso_wipcs_age35to49,
                       metrics_model2_lasso_wipcs_age15to34,
                       metrics_model2_lasso_wipcs_white,
                       metrics_model2_lasso_wipcs_black,
                       metrics_model2_lasso_wipcs_mixed,
                       metrics_model2_lasso_wipcs_asian,
                       metrics_model2_lasso_wipcs_other)

saveRDS(model2b_metrics,"model2b_metrics130923_15to49020624 FinalV2.rds")


```




## Calibration using pseudo values - Model 2b


```{r}

validation_data1$model2_lasso_lp_wipc <- predict(model2_lasso_wipcs,type="lp")

s10 <- summary(survfit(model2_lasso_wipcs),time=10)$surv
s10
s10_model2b=s10
validation_data1$risk_model2_lasso_wipcs = riskRegression::predictRisk(model2_lasso_wipcs,newdata=validation_data1,times = 10)

validation_data1$risk_model2_lasso_wipcs = riskRegression::predictRisk(model2_lasso_wipcs,validation_data1,times = 10)

```


```{r}

# Calibration plot (pseudo-obs approach) ----------------------------------
# First compute riskRegression::Score()

vdata <- validation_data1 %>% 
  dplyr::select(PRACTICE_PATIENT_ID, risk_model2_lasso_wipcs, time1,status1) 

names(vdata)=c("ID","score","time","status")

primary_event <- 1

# Add estimated risk and complementary log-log of it to dataset
vdata$pred <- vdata$score
horizon <- 10
pred <- as.matrix(vdata$pred)


score_vdata <- riskRegression::Score(
  list("QRISK3_validation" = pred),
  formula = Hist(time, status) ~ 1,
  cens.model = "km",
  data = vdata,
  conf.int = TRUE,
  times = horizon,
  #  metrics = c("auc", "brier"),
  summary = c("ipa"),
  cause = primary_event,
  plots = "calibration"
)

```


#### Mean calibration

```{r}
# Observed / Expected ratio

# Observed
obj <- summary(survfit(
  Surv(time, status) ~ 1, 
  data = vdata),
  times = horizon)

obs_t <- 1 - obj$surv

# Expected
exp_t <- mean(vdata$score)

# Observed / Expected ratio
OE_t <- obs_t / exp_t

alpha <- .05
OE_summary <- c(
  "OE" = OE_t,
  "2.5 %" = OE_t * exp(-qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event)),
  "97.5 %" = OE_t * exp(+qnorm(1 - alpha / 2) * sqrt(1 / obj$n.event))
)

OE_summary = data.frame(OE_summary)
OE_summary$estimate_name = row.names(OE_summary)
OE_summary = OE_summary %>% spread(estimate_name,OE_summary) 

OE_summary$model = "Model 2b overall"

OE_summary_Model2b = OE_summary

```


#### Weak calibration: Calibration slope and intercept


```{r}
# Use pseudo-observations calculated by Score() (can alternatively use pseudo::pseudoci)
pseudos <- data.frame(score_vdata$Calibration$plotframe)

# Note:
# - 'pseudos' is the data.frame with ACTUAL pseudo-observations, not the smoothed ones
# - Column ID is not the id in vdata; it is just a number assigned to each row of
# the original validation data sorted by time and event indicator
pseudos$cll_pred <- log(-log(1 - pseudos$risk)) # add the cloglog risk ests

# Fit model for calibration intercept
fit_cal_int <- geese(
  pseudovalue ~ offset(cll_pred),
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Fit model for calibration slope
fit_cal_slope <- geese(
  pseudovalue ~ offset(cll_pred) + cll_pred,
  data = pseudos,
  id = ID,
  scale.fix = TRUE,
  family = gaussian,
  mean.link = "cloglog",
  corstr = "independence",
  jack = TRUE
)

# Perform joint test on intercept and slope
betas <- fit_cal_slope$beta
vcov_mat <- fit_cal_slope$vbeta
wald <- drop(betas %*% solve(vcov_mat) %*% betas)
# pchisq(wald, df = 2, lower.tail = FALSE)

k <- 2
res_cal <- rbind(

  # Value, confidence interval and test for calibration intercept
  "Intercept" = with(
    summary(fit_cal_int)$mean,
    c(
      "estimate" = estimate,
      `2.5 %` = estimate - qnorm(0.975) * san.se,
      `97.5 %` = estimate + qnorm(0.975) * san.se
    )
  ),

  # Value, confidence interval and test for calibration slope
  "Slope" = with(
    summary(fit_cal_slope)$mean["cll_pred", ],
    c(
      "estimate" = 1 + estimate,
      `2.5 %` = 1 + (estimate - qnorm(0.975) * san.se),
      `97.5 %` = 1 + (estimate + qnorm(0.975) * san.se)
    )
  )
)
res_cal = data.frame(res_cal)
res_cal$model = "Model 2b overall"
res_cal_Model2b = res_cal

```


## Combining Metrics

### Performance measures

```{r}
all_metrics = rbind(qrisk3_metrics
,model1_metrics,
model2a_metrics,
model2b_metrics)


all_metrics$model1 = c("QRISK3","QRISK3, < 25","QRISK3, 25-34","QRISK3, 35-49","QRISK3, 15-34","QRISK3, White","QRISK3, Black","QRISK3, Mixed","QRISK3, Asian","QRISK3, Other",
                       
                       "Model 1","Model 1, < 25","Model 1, 25-34","Model 1, 35-49","Model 1, 15-34","Model 1, White","Model 1, Black","Model 1, Mixed","Model 1, Asian","Model 1, Other",
                       
                       
                       "Model 2a","Model 2a, < 25","Model 2a, 25-34","Model 2a, 15-34","Model 2a, 35-49","Model 2a, White","Model 2a, Black","Model 2a, Mixed","Model 2a, Asian","Model 2a, Other",
                       
                       "Model 2b","Model 2b, < 25","Model 2b, 25-34","Model 2b, 35-49","Model 2b, 15-34","Model 2b, White","Model 2b, Black","Model 2b, Mixed","Model 2b, Asian","Model 2b, Other"

                       )

saveRDS(all_metrics,"all_metrics130923_15to49V2020624 FinalV2.rds")

```


```{r}
metrics = all_metrics

metrics = readRDS("all_metrics130923_15to49V2020624 FinalV2.rds")
  
```


```{r}

metrics$C_stats <- ifelse(is.na(metrics$C_LL), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     metrics$C, metrics$C_LL, metrics$C_UL))

metrics$D_stats <- ifelse(is.na(metrics$D_LL), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     metrics$D, metrics$D_LL, metrics$D_UL))


metrics$Dist <- ifelse(is.na(metrics$D_LL), "",
                             sprintf("%.3f (%.3f)",
                                     metrics$Mean, metrics$sd))

metrics$TD_AUC_stats = ifelse(is.na(metrics$TD_AUC_LL), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     metrics$TD_AUC, metrics$TD_AUC_LL, metrics$TD_AUC_UL))

metrics$R2D = round(metrics$R2D,4)

metrics = metrics[,c("Model","Calibration_slope","C_stats","Uno_TD_C","D_stats","Dist","TD_AUC_stats","R2D")]

#metrics = tibble::rownames_to_column(metrics,"model2")


names(metrics)=c("Model","Calibration slope","Harrell's C","Uno's time dependent C","Royston's D","Distribution of LP","Time dependent AUC","R2D")

metrics$group <- word(metrics$Model, - 1)
metrics$group = recode(metrics$group,"25"="<25","1"="Model 1","2a"="Model 2a","2a,Black"="Black","2b"="Model 2b")

metrics$group2 <- sub(",.*", "", metrics$Model)  


overall_metrics = filter(metrics,group %in% c("QRISK3","Model 1","Model 2a","Model 2b"))

write.csv(overall_metrics,"overall_metrics020624 FinalV2.csv")


subgroup_metrics = filter(metrics, !group %in% c("QRISK3","Model 1","Model 2a","Model 2b"))



```


```{r}
overall_metrics$group3 = "Overall"
overall_metrics = overall_metrics[,c(1,11,3,7,5,8,6)]

write.csv(overall_metrics,"OverallMetricsClean151023020624 FinalV2.csv")


subgroup_metrics$group3 = "Subgroup"
subgroup_metrics = subgroup_metrics[,c(10,9,11,3,7,5,8,6)]
subgroup_metrics = subgroup_metrics %>% dplyr::rename(Model = group2)

subgroup_metrics$Model = ifelse(subgroup_metrics$Model=="QRISK3","3rdQRISK",subgroup_metrics$Model)
subgroup1 =subgroup_metrics %>% arrange(group,Model)

write.csv(subgroup1,"SubgroupMetricsClean151023020624 FinalV2.csv")
```



```{r}
subgroup_metrics = read.csv("SubgroupMetricsClean151023020624 FinalV2.csv")
subgroup_metrics$group = ifelse(subgroup_metrics$group=="Other","Others",subgroup_metrics$group)
events_subgroups = read.csv("/rds/projects/g/gokhalkm-optimal/DataForSteven/CVD events in groups 240124.csv")

events_subgroups = events_subgroups %>% dplyr::rename(group=Subgroup)

combined_subgroup_metrics = left_join(subgroup_metrics,events_subgroups,by=c("group"))

combined_subgroup_metrics = combined_subgroup_metrics[,c(2,3,12,11,5,6,7,8,9)]


#combined_subgroup_metrics$kk <- substr(combined_subgroup_metrics$CVD.Events.within.10.years, start = 1, stop = 4)


combined_subgroup_metrics$CVD.Events.within.10.years <- substr(combined_subgroup_metrics$CVD.Events.within.10.years, start = 1, stop = 4)


#combined_subgroup_metrics$CVD.Events.within.10.years <- word(combined_subgroup_metrics$CVD.Events.within.10.years, 2)

names(combined_subgroup_metrics)=c("Model", "Sub-group", "Number of women (%)", "CVD Events within 10 years", "Harrell's C", 
"Time dependent AUC", "Royston's D", "R2D", "Distribution of LP")

write.csv(combined_subgroup_metrics,"combined_subgroup_metrics020624 FinalV2.csv")

```


### Hazard Ratios

```{r}

estimatesModel2b = read.csv("estimatesModel2b.csv")
estimatesModel2a = read.csv("estimatesModel2a.csv")
estimatesModel1 = read.csv("estimatesModel1.csv")
Model2s = left_join(estimatesModel2b,estimatesModel2a,by=c("Variables"))


all_models = full_join(Model2s,estimatesModel1,by="Variables")
all_models = all_models[,c(-1,-4,-6)]

all_models = all_models[,c(1,4,3,2)]


all_models$Predictors = c("Age1","BMI 1","SBP 1","Townsend scores","Number of pregnancies","Black ethnicity","Mixed ethnicity","Asian ethnicity","Other ethnicity","Ex smoker","Current smoker","Atrial Fibrillation","Atypical antipsychotics","Corticosteroid use","Migraine","Rhematoid Arthritis","CKD","Severe mental illness","SLE","Treated hypertension","Diabetes Type 1","Diabetes Type 2","Family history of CVD","Pre-eclampsia","Postnatal depression","GDM","Gestational hypertension","Miscarriage","Endometriosis","PCOS","Stillbirth","QRISK3 linear predictor 1","QRISK3 linear predictor 2" ,"Small for gestational age","Preterm birth","Irregular menses","Placental abruption")

#all_models = all_models[c(1,3,5,25,8:11,6,2,4,12:14,17:18,19:21,23:24,15:16,22,37:38,26:32,36,33:35,7),]

all_models = all_models[,c(5,2:4)]
all_models[is.na(all_models)]="-"
write.csv(all_models,"Hazard Ratios020624 FinalV2.csv",row.names = F)

```


```{r}

all_models = all_models[c(
  
  32, 
  33,
  1:4,
  23,
  6:9,
  10:11,
  12,
  15:19,
  21:22,
  13:14,
  20,
  24:28,
  35,
  31,
  34,
  5,
  29,
  30,
  36,
  37
  
),]

write.csv(all_models,"Hazard Ratios Clean.csv",row.names = F)


```







### Hazard Ratios checking

```{r}

estimatesModel2b = read.csv("estimatesModel2b.csv")
estimatesModel2b$Predictors = c("Age1","BMI 1","SBP 1","Townsend scores","Number of pregnancies","Black ethnicity","Mixed ethnicity","Asian ethnicity","Other ethnicity","Ex smoker","Current smoker","Atrial Fibrillation","Atypical antipsychotics","Corticosteroid use","Migraine","Rhematoid Arthritis","CKD","Severe mental illness","SLE","Treated hypertension","Diabetes Type 1","Diabetes Type 2","Family history of CVD","Pre-eclampsia","Postnatal depression","GDM","Gestational hypertension","Miscarriage","Endometriosis","PCOS","Stillbirth")
estimatesModel2b = estimatesModel2b[,-c(1:2)]

estimatesModel2a = read.csv("estimatesModel2a.csv")
estimatesModel2a$Predictors = c("Age1","BMI 1","SBP 1","Townsend scores","Black ethnicity","Mixed ethnicity","Asian ethnicity","Other ethnicity","Ex smoker","Current smoker","Atrial Fibrillation","Atypical antipsychotics","Corticosteroid use","Migraine","Rhematoid Arthritis","CKD","Severe mental illness","SLE","Treated hypertension","Diabetes Type 1","Diabetes Type 2","Family history of CVD")
estimatesModel2a = estimatesModel2a[,-c(1:2)]

Model2s = left_join(estimatesModel2b,estimatesModel2a,by=c("Predictors"))


estimatesModel1 = read.csv("estimatesModel1.csv")
estimatesModel1$Predictors = c("QRISK3 linear predictor 1","QRISK3 linear predictor 2",
                               "Number of pregnancies","Pre-eclampsia","Small for gestational age","Postnatal depression","GDM","Gestational hypertension","Miscarriage","Preterm birth","Endometriosis","Irregular menses","PCOS","Placental abruption","Stillbirth")
estimatesModel1 = estimatesModel1[,-c(1:2)]


all_models = full_join(Model2s,estimatesModel1,by="Predictors")
all_models = all_models[,c(2,4,3,1)]
all_models = all_models[c(1:4,6:23,33:34,24:32,35:37,5),]

all_models[is.na(all_models)]="-"
write.csv(all_models,"Hazard Ratios140624.csv",row.names = F)

```


### Baseline survival

```{r}

basehazards = data.frame(Model = c("QRISK3","QRISK3 recalibrated","Model 1","Model 2a","Model 2b"),Baseline_Hazard = c(s10_qrisk3,s10_qrisk3_recal,s10_model1,s10_model2a,s10_model2b))

saveRDS(basehazards,"Baseline Hazards020624 FinalV2.rds")

base = readRDS("Baseline Hazards020624 FinalV2.rds")

write.csv(base,"baseline_survival.csv")
```


#
### Mean Calibration

```{r}
mean_calibration = rbind(OE_summary_QRISK3,OE_summary_QRISK3_Recal,OE_summary_Model1,OE_summary_Model2a,OE_summary_Model2a,OE_summary_Model2b)

saveRDS(mean_calibration,"Mean_Calibration151023020624 FinalV2.rds")

mn = readRDS("Mean_Calibration151023020624 FinalV2.rds")

mn$'OE (95% CI)' <- ifelse(is.na(mn$`2.5 %`), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     mn$OE, mn$`2.5 %`, mn$`97.5 %`))

mn1 = mn[,c(4,5)]

mn1$model = recode(mn1$model,"QRISK 3 overall"="QRISK3 overall","QRISK 3 overall Recal"="QRISK3 overall Recal")

write.csv(mn1,"Mean_Calibration151023020624 FinalV2.csv",row.names = F)

```

### Calibration slope and intercept

```{r}
weak_calibration = rbind(res_cal_QRISK3,res_cal_QRISK3_Recal,res_cal_Model1,res_cal_Model2a,res_cal_Model2b)

saveRDS(weak_calibration,"Weak_Calibration151023020624 FinalV2.rds")

mn = readRDS("Weak_Calibration151023020624 FinalV2.rds")


mn$'Estimate (95% CI)' <- ifelse(is.na(mn$X2.5..), "",
                             sprintf("%.3f (%.3f to %.3f)",
                                     mn$estimate, mn$X2.5.., mn$X97.5..))

mn$Estimate_name = c("Intercept","Slope","Intercept","Slope","Intercept","Slope","Intercept","Slope","Intercept","Slope")

mn2 = mn[,c(4:6)] %>% spread(Estimate_name,'Estimate (95% CI)')


write.csv(mn2,"Weak_Calibration151023020624 FinalV2.csv")

```



```{r}
mn3 = left_join(mn1,mn2,by=c("model"))

write.csv(mn3,"Overall_Calibration_Stats020624 FinalV2.csv",row.names = F)
```


### Clinical utility

```{r}
library(dcurves)

pdf("Clinical utility020624 FinalV2.pdf")

dca(Surv(time1, status1)~score0+score+risk_model1_fp+risk_model2_lasso+risk_model2_lasso_wipcs,
    data = validation_data1,
    time = 10,
    thresholds = seq(0, 0.5, 0.01),
    label = list(score0="QRISK3",score="QRISK3 recalibrated",risk_model1_fp="Model 1",risk_model2_lasso="Model 2a",risk_model2_lasso_wipcs="Model 2b"))%>% standardized_net_benefit()%>%
  plot(smooth = TRUE) -> p1

print(p1)
dev.off()

```


### Save all data

```{r}

saveRDS(validation_data1,"validation_data_with_scoresOverall.rds")


```




```{r}
validation_data1 = readRDS("validation_data_with_scoresOverall.rds")
```



```{r}
x=dca(Surv(time1, status1)~score0+score+risk_model1_fp+risk_model2_lasso+risk_model2_lasso_wipcs,
    data = validation_data1,
    time = 10,
    thresholds = seq(0, 0.15, 0.01),
    label = list(score0="QRISK3",score="QRISK3-Recalibrated",risk_model1_fp="Model 1",risk_model2_lasso="Model 2a",risk_model2_lasso_wipcs="Model 2b"))%>% standardized_net_benefit()

#x1=x[["dca"]]

p2=as_tibble(x) %>%
  dplyr::filter(!is.na(standardized_net_benefit)) %>%
  ggplot(aes(x = threshold, y = standardized_net_benefit, color = label)) +
  stat_smooth(method = "loess", se = FALSE, formula = "y ~ x", 
    span = 0.33,size=5) +
  coord_cartesian(ylim = c(-0.02, 1.02)) +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Threshold Probability", y = "Standardized Net Benefit", 
    color = "") +
  theme_bw()+theme(text = element_text(size=50,face="bold"),
        axis.title=element_text(size=50,face="bold"),
        axis.text.x = element_text(angle=90, hjust=1,vjust = 1,size = 50),
        axis.text.y = element_text(size = 50),
        axis.text=element_text(size=50))

ggsave(p2,filename = "Clinical_Utility_Final2.jpeg",width = 35,height = 30, dpi=300)

ggsave(p2,filename = "Clinical_Utility_Final2.pdf",width = 35,height = 30, dpi=300)





```








```{r}
rm(list = ls())
library(plyr)
library(tidyverse)
#library(tidysurv)
library(data.table)
library(stringr)
library(parallel)
library(tableone)
library(muhaz)
library(survival)
library(Hmisc)
library(MASS)
library(mfp)
library(reshape2)
library(flexsurv)
library(devtools)
library(prodlim)
library(rms)
library(rstpm2)
library(survcomp)
library(glmnet)
library(caret)
library(sjPlot)
library(knitr)
library(webshot)
```


```{r}
df = readRDS("validation_data_with_scoresOverall.rds")
```



<!-- ```{r} -->
<!-- df = df %>% dplyr::select(-LP,-model1_fp_lp,-score0,-score,-risk_model1_fp) -->

<!-- df2 = readRDS("/Users/ssw107/Library/CloudStorage/OneDrive-UniversityofBirmingham/MuM-PreDiCT/Risk prediction model/Manuscript/Calibration plots/Distribution of risk/UpdatedQRISK3andModel1_Main.rds") -->

<!-- df2 = df2 %>% dplyr::select(PRACTICE_PATIENT_ID,LP,model1_fp_lp,score0,score,risk_model1_fp) -->
<!-- df = left_join(df,df2,by=c("PRACTICE_PATIENT_ID")) -->

<!-- ``` -->




```{r}
summary = df %>% dplyr::group_by(age_cat) %>%
                 dplyr::summarise(n=n(),
                           
                           #Followup (overall)
                           median_followup = median(time1),
                           mean_followup = mean(time1),
                           sd_followup = sd(time1),
                           q1_followup = quantile(time1, probs = 0.25),
        q3_followup = quantile(time1, probs = 0.75),
        IQR_followup = q3_followup -  q1_followup,
        min_followup = min(time1),
        max_followup = max(time1),
        
        #Followup (Censored at 10 years)
                           median_followupC = median(time),
                           mean_followupC = mean(time),
                           sd_followupC = sd(time),
                           q1_followupC = quantile(time, probs = 0.25),
        q3_followupC = quantile(time, probs = 0.75),
        IQR_followupC = q3_followupC -  q1_followupC,
        min_followupC = min(time),
        max_followupC = max(time),
      
        #Events
        events = sum(status1),
        eventsC = sum(status)
                 )


write.csv(summary,"/rds/projects/g/gokhalkm-optimal/DataForSteven/Results June 2024/Calibration in stata/Overall/age_summary.csv")


```




```{r}

df$age_cat1 = ifelse(df$age_cat=="35-49","35-49","15-34")


summary1 = df %>% dplyr::group_by(age_cat1) %>%
                 dplyr::summarise(n=n(),
                           
                           #Followup (overall)
                           median_followup = median(time1),
                           mean_followup = mean(time1),
                           sd_followup = sd(time1),
                           q1_followup = quantile(time1, probs = 0.25),
        q3_followup = quantile(time1, probs = 0.75),
        IQR_followup = q3_followup -  q1_followup,
        min_followup = min(time1),
        max_followup = max(time1),
        
        #Followup (Censored at 10 years)
                           median_followupC = median(time),
                           mean_followupC = mean(time),
                           sd_followupC = sd(time),
                           q1_followupC = quantile(time, probs = 0.25),
        q3_followupC = quantile(time, probs = 0.75),
        IQR_followupC = q3_followupC -  q1_followupC,
        min_followupC = min(time),
        max_followupC = max(time),
      
        #Events
        events = sum(status1),
        eventsC = sum(status)
                 )


write.csv(summary1,"/rds/projects/g/gokhalkm-optimal/DataForSteven/Results June 2024/Calibration in stata/Overall/age_summary1.csv")
```


```{r}
summary = df %>% dplyr::group_by(cprd_ethnicity3) %>%
                 dplyr::summarise(n=n(),
                           #Followup (overall)
                           median_followup = median(time1),
                           mean_followup = mean(time1),
                           sd_followup = sd(time1),
                           q1_followup = quantile(time1, probs = 0.25),
        q3_followup = quantile(time1, probs = 0.75),
        IQR_followup = q3_followup -  q1_followup,
        min_followup = min(time1),
        max_followup = max(time1),
        
        #Followup (Censored at 10 years)
                           median_followupC = median(time),
                           mean_followupC = mean(time),
                           sd_followupC = sd(time),
                           q1_followupC = quantile(time, probs = 0.25),
        q3_followupC = quantile(time, probs = 0.75),
        IQR_followupC = q3_followupC -  q1_followupC,
        min_followupC = min(time),
        max_followupC = max(time),
      
        #Events
        events = sum(status1),
        eventsC = sum(status)
                 )


write.csv(summary,"/rds/projects/g/gokhalkm-optimal/DataForSteven/Results June 2024/Calibration in stata/Overall/ethnicity_summary.csv")

```


#### Select risk scores and predictors 

```{r}

scores = df %>% dplyr::select(PRACTICE_PATIENT_ID,age,bmi,rati,sbp,sbps5,town,cprd_ethnicity3,White,Indian,Pakistani,Banglandeshi,Other_asian,Black_caribbean,Black_african,Chinese,Other_ethnicity,Non_smoker,Ex_smoker,Light_smoker,Moderate_smoker,Heavy_smoker,b_AF,b_atypicalantipsy,b_corticosteroids,b_migraine,b_ra,b_renal,b_semi,b_sle,b_treatedhyp,b_type1,b_type2,fh_cvd,score0,score,risk_model1_fp,risk_model2_lasso,risk_model2_lasso_wipcs,LP,model1_fp_lp,model2_lasso_lp_wopc,model2_lasso_lp_wipc,age_cat1,status,status1,time,time1) %>% dplyr::rename(
  
  ###Scores
  QRISK3_score = score0,QRISK3_recalibrated_score = score,Model1_score=risk_model1_fp,Model2a_score=risk_model2_lasso,Model2b_score=risk_model2_lasso_wipcs,
  
  ### linear predictors
  
   QRISK3_LP = LP,Model1_LP=model1_fp_lp,Model2a_LP=model2_lasso_lp_wopc,Model2b_LP=model2_lasso_lp_wipc
  )

```



```{r}

scores0 = df %>% dplyr::select(PRACTICE_PATIENT_ID,cprd_ethnicity3,
                               
                               cprd_white,cprd_black,cprd_mixed,cprd_asian,cprd_other,
                               
                               score0,score,risk_model1_fp,risk_model2_lasso,risk_model2_lasso_wipcs,LP,model1_fp_lp,model2_lasso_lp_wopc,model2_lasso_lp_wipc,age_cat1,status,status1,time,time1) %>% dplyr::rename(
                                 
                                 
                                 
   ### Ethnicity
    ethnicity = cprd_ethnicity3,
    white_ethnicity = cprd_white,
    black_ethnicity = cprd_black,
    mixed_ethnicity = cprd_mixed,
    asian_ethnicity = cprd_asian,
    other_ethnicity = cprd_other,
    
    ### Age
    age_cats = age_cat1,
  
  ###Scores
  QRISK3_score = score0,QRISK3_recalibrated_score = score,Model1_score=risk_model1_fp,Model2a_score=risk_model2_lasso,Model2b_score=risk_model2_lasso_wipcs,
  
  ### linear predictors
  
   QRISK3_LP = LP,Model1_LP=model1_fp_lp,Model2a_LP=model2_lasso_lp_wopc,Model2b_LP=model2_lasso_lp_wipc
  )

scores0 = scores0[,c(17,2:7,13:16,8:12,21,19,20,18)]

library(haven)
saveRDS(scores0,"/rds/projects/g/gokhalkm-optimal/DataForSteven/Results June 2024/Calibration in stata/Overall/DataWithScores070624.rds")
write_dta(scores0,"/rds/projects/g/gokhalkm-optimal/DataForSteven/Results June 2024/Calibration in stata/Overall/DataWithScores070624.dta")

```






#### Distribution of risk overall
##### Correlation plot

```{r}
library(corrplot)

risk_overall = scores %>% dplyr::select(PRACTICE_PATIENT_ID,QRISK3_score,QRISK3_recalibrated_score,Model1_score,Model2a_score,Model2b_score)
names(risk_overall)=c("patient_id","QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b")
M = cor(risk_overall[,-1])
corrplot(M, method = 'number') # colorful number

```

##### Overall distribution of risk


```{r}
risk_overall = reshape2::melt(risk_overall,id=c("patient_id"))
risk_overall$variable=factor(risk_overall$variable,levels = c("QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b"))

```


```{r}

ggplot(risk_overall, aes(x = value, fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+ xlab("risk score") +
  ylab("Frequency")+theme(legend.position="bottom") 

```


```{r}
ggplot(risk_overall, aes(x = log(value), fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+ xlab("log(risk score)") +
  ylab("Frequency")+theme(legend.position="bottom") 
```

##### Distribution of risk by age

```{r}

risk_age = scores %>% dplyr::select(PRACTICE_PATIENT_ID,age_cat1,QRISK3_score,QRISK3_recalibrated_score,Model1_score,Model2a_score,Model2b_score)
names(risk_age)=c("patient_id","Age","QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b")

```

```{r}
risk_age = reshape2::melt(risk_age,id=c("patient_id","Age"))
risk_age$variable=factor(risk_age$variable,levels = c("QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b"))
```


```{r}
ggplot(risk_age, aes(x = value, fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+xlab("risk score") +
  ylab("Frequency")+
  facet_wrap(~Age)+theme(legend.position="bottom") 
```


```{r}
ggplot(risk_age, aes(x = log(value), fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+
  facet_wrap(~Age)+ xlab("log(risk score)") +
  ylab("Frequency")+theme(legend.position="bottom") 
```




##### Distribution of risk by ethnicity

```{r}

risk_Ethnicity = scores %>% dplyr::select(PRACTICE_PATIENT_ID,cprd_ethnicity3,QRISK3_score,QRISK3_recalibrated_score,Model1_score,Model2a_score,Model2b_score)
names(risk_Ethnicity)=c("patient_id","Ethnicity","QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b")

```

```{r}
risk_Ethnicity = reshape2::melt(risk_Ethnicity,id=c("patient_id","Ethnicity"))
risk_Ethnicity$variable=factor(risk_Ethnicity$variable,levels = c("QRISK3","Re-calibrated QRISK3","Model 1","Model 2a","Model 2b"))
risk_Ethnicity$Ethnicity=factor(risk_Ethnicity$Ethnicity,levels = c("White","Black","Asian","Mixed","Others"))


```


```{r}
ggplot(risk_Ethnicity, aes(x = value, fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+xlab("risk score") +
  ylab("Frequency")+
  facet_wrap(~Ethnicity)+theme(legend.position="bottom") 
```


```{r}
ggplot(risk_Ethnicity, aes(x = log(value), fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+
  facet_wrap(~Ethnicity)+ xlab("log(risk score)") +
  ylab("Frequency")+theme(legend.position="bottom") 
```



```{r}
ggplot(risk_Ethnicity, aes(x = log(value), fill = variable, colour = variable)) + 
  geom_histogram(alpha = 0.5, position = "identity") + 
  guides(fill = guide_legend(title = "Model"),
         colour = guide_legend(title = "Model"))+theme_bw()+
  facet_wrap(~Ethnicity,scales = "free_y")+ xlab("log(risk score)") +
  ylab("Frequency")+theme(legend.position="bottom") 
```





